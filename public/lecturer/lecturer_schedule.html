<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jadwal Bimbingan - Dosen</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <div class="container-fluid h-100">
    <div class="row h-100">
      <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

      <div class="col-md-9 col-lg-10 h-100 p-0 position-relative">
        <div class="main-content-scrollable">
          
          <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
              <h2 class="fw-bold text-primary mb-1">Jadwal Bimbingan</h2>
              <p class="text-muted small">Kelola jadwal bimbingan mahasiswa Anda</p>
            </div>
            <div class="d-flex align-items-center gap-3">
              <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3 d-flex align-items-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Logout
              </button>
              <div class="notification-circle">
                <i class="fas fa-bell fa-lg text-secondary"></i>
                <span class="badge-dot">2</span>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-2">
              <select id="student-filter"
                class="form-select border-0 shadow-sm rounded-pill px-4 py-2 text-secondary fw-bold"
                style="width: 280px; cursor: pointer">
                <option value="all">Semua Mahasiswa</option>
              </select>
            </div>
            <button id="btn-add-schedule" onclick="openCreateScheduleModal()"
              class="btn btn-primary-custom rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
              <i class="fas fa-plus"></i> Ajukan Bimbingan
            </button>
          </div>

          <div id="schedule-container"></div>

          <div style="height: 50px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="rescheduleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow" style="border-radius: 20px">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold text-primary px-3 pt-3">Atur Ulang Jadwal</h5>
          <button type="button" class="btn-close me-3 mt-3" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <form id="formReschedule">
            <input type="hidden" id="rescheduleAppId" />
            <input type="hidden" id="rescheduleStudentId" /> 
            <input type="hidden" id="rescheduleLecturerIds" />

            <div class="mb-3">
              <label class="form-label small fw-bold text-secondary">Tanggal Baru</label>
              <input type="date" id="newDate" class="form-control rounded-pill bg-light border-0" required onchange="fetchRescheduleSlots()" />
            </div>

            <div class="mb-3">
              <label class="form-label small fw-bold text-secondary">Waktu Tersedia</label>
              <div id="reschSlotContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background: #f8f9fa">
                  <small class="text-muted d-block text-center py-3">Pilih tanggal baru untuk melihat slot.</small>
              </div>
              <input type="hidden" id="reschSelectedTime" required>
            </div>

            <div class="mb-4">
              <label class="form-label small fw-bold text-secondary">Alasan Perubahan</label>
              <textarea id="rescheduleReason" class="form-control bg-light border-0" rows="2"
                style="border-radius: 15px" placeholder="Contoh: Ada rapat mendadak"></textarea>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary-custom rounded-pill fw-bold">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="createScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow" style="border-radius: 15px">
        <div class="modal-header border-0 pb-0 pt-4 px-4">
          <h5 class="fw-bold">Buat Jadwal Bimbingan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-4">
          <form id="createScheduleForm">
  <div class="mb-3">
    <label class="small fw-bold text-muted mb-1">Mahasiswa</label>
    <select id="targetStudent" class="form-select rounded-pill" required onchange="onStudentChange()">
      <option value="">Loading...</option>
    </select>
  </div>

  <div class="mb-3" id="groupMode" style="display: none">
    <label class="small fw-bold text-muted mb-1">Jenis Bimbingan</label>
    <select id="scheduleMode" class="form-select rounded-pill bg-light border-0 text-primary fw-bold" onchange="fetchAvailableSlots()">
      <option value="individual">Individual (Saya Saja)</option>
      <option value="joint">Gabungan (Dengan Partner)</option>
    </select>
  </div>

  <div class="row">
      <div class="col-md-6 mb-3">
        <label class="small fw-bold text-muted mb-1">Tipe Jadwal</label>
        <select id="inputType" class="form-select rounded-3" onchange="toggleFormType()">
          <option value="single">Sekali (Single)</option>
          <option value="recurring">Berulang (Recurring)</option>
        </select>
      </div>

      <div class="col-md-6 mb-3" id="groupFrequency" style="display: none;">
        <label class="small fw-bold text-muted mb-1">Ulangi Setiap</label>
        <div class="input-group">
            <input type="number" id="inputFreqVal" class="form-control text-center" value="1" min="1">
            <select id="inputFreqUnit" class="form-select bg-light" style="flex: 1.5;">
                <option value="week">Minggu</option>
                <option value="month">Bulan</option>
            </select>
        </div>
      </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="small fw-bold text-muted mb-1">Tanggal Mulai</label>
      <input type="date" id="inputStartDate" class="form-control rounded-3" required onchange="fetchAvailableSlots()"/>
    </div>
    <div class="col-md-6 mb-3" id="groupEndDate" style="display: none">
      <label class="small fw-bold text-muted mb-1">Berakhir Tanggal</label>
      <input type="date" id="inputEndDate" class="form-control rounded-3" />
    </div>
  </div>

  <div class="mb-3">
    <label class="small fw-bold text-muted mb-1">Pilih Waktu Tersedia</label>
    <div id="slotContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background: #f8f9fa">
      <small class="text-muted d-block text-center py-3"> Pilih mahasiswa dan tanggal untuk melihat slot. </small>
    </div>
    <input type="hidden" id="selectedTimeRange" required />
  </div>

  <hr class="dashed-line my-3" />

  <div class="mb-3">
    <label class="small fw-bold text-muted mb-2 d-block">Metode</label>
    <div class="d-flex gap-4">
      <div class="form-check">
        <input class="form-check-input" type="radio" name="inputMode" id="modeOnline" value="online" checked onchange="toggleLocLabel()" />
        <label class="form-check-label" for="modeOnline">Online</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="inputMode" id="modeOnsite" value="onsite" onchange="toggleLocLabel()" />
        <label class="form-check-label" for="modeOnsite">On Site</label>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <label class="small fw-bold text-muted mb-1" id="labelLoc">Link Meeting</label>
    <input type="text" id="inputLocation" class="form-control rounded-3" required />
  </div>

  <div class="mb-4">
    <label class="small fw-bold text-muted mb-1">Catatan</label>
    <textarea id="inputNotes" class="form-control rounded-3" rows="2"></textarea>
  </div>

  <div class="d-grid">
    <button type="submit" class="btn btn-primary-custom rounded-pill fw-bold">Simpan Jadwal</button>
  </div>
</form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/sidebar.js"></script>
  <script src="../js/notification.js"></script>
  
  <script>
    // ==========================================
    // LECTURER SCHEDULE LOGIC
    // ==========================================

    let currentLecturerId = null;
    let currentSupervisors = []; 

    document.addEventListener("DOMContentLoaded", () => {
      const userSession = JSON.parse(localStorage.getItem("user_session"));
      if (!userSession || userSession.role !== "lecturer") {
        window.location.href = "/login";
        return;
      }
      currentLecturerId = userSession.user_id;

      fetchMyStudents();
      fetchSchedules("all");
      setupEventListeners();
    });

    function setupEventListeners() {
      // Filter Mahasiswa
      document.getElementById("student-filter").addEventListener("change", (e) => {
        fetchSchedules(e.target.value);
      });

      // Submit Form Reschedule
      document.getElementById("formReschedule").addEventListener("submit", handleRescheduleSubmit);

      // Submit Form Create Schedule
      document.getElementById("createScheduleForm").addEventListener("submit", handleCreateSchedule);
    }

    // --- VIEW & LIST DATA ---

    async function fetchMyStudents() {
      try {
        const response = await fetch(`/api/lecturer/students/${currentLecturerId}`);
        const result = await response.json();

        const select = document.getElementById("student-filter");
        select.innerHTML = '<option value="all">Semua Mahasiswa</option>';

        if (result.success) {
          result.data.forEach((student) => {
            const option = document.createElement("option");
            option.value = student.user_id;
            option.textContent = `${student.name} (${student.npm})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error("Gagal memuat mahasiswa:", error);
      }
    }

    async function fetchSchedules(studentId) {
      const container = document.getElementById("schedule-container");
      container.innerHTML = '<div class="text-center py-5 text-muted"><div class="spinner-border text-primary mb-2"></div><br>Memuat jadwal...</div>';

      try {
        const response = await fetch(`/api/lecturer/schedules/${currentLecturerId}?studentId=${studentId}`);
        const result = await response.json();

        if (result.success) {
          renderSchedules(result.data);
        } else {
          container.innerHTML = `<div class="text-center text-danger">${result.message}</div>`;
        }
      } catch (error) {
        console.error("Error:", error);
      }
    }

    function renderSchedules(data) {
      const container = document.getElementById("schedule-container");

      // [REVISI] Filter Data: Hanya tampilkan yang statusnya BUKAN 'completed'
      // Kita juga menyembunyikan 'rejected' agar tidak memenuhi tampilan
      const activeSchedules = data.filter(item => {
          return item.status !== 'completed' && item.status !== 'rejected';
      });

      if (activeSchedules.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="far fa-calendar-times fa-3x mb-3"></i>
                <p>Tidak ada jadwal bimbingan aktif.</p>
            </div>`;
        return;
      }

      let html = "";
      
      // Looping data yang sudah difilter (activeSchedules)
      activeSchedules.forEach((item) => {
        const locationDisplay = item.type === "Online" ? (item.link ? `<a href="${item.link}" target="_blank" class="text-decoration-none text-primary fw-bold">${item.link}</a>` : "-") : item.location || "--";

        // Logic Tombol: Hanya munculkan Reschedule & Selesai jika status APPROVED
        let actionButtons = "";
        if (item.status === 'approved') {
             actionButtons = `
             <button class="btn btn-sm btn-success rounded-pill px-3 fw-bold shadow-sm me-1" 
                     onclick="markAsComplete(${item.id})" title="Tandai Selesai">
                 <i class="fas fa-check-double me-1"></i> Selesai
             </button>
             <button class="btn btn-sm btn-outline-primary rounded-pill px-4 fw-bold shadow-sm" 
                     onclick="openRescheduleModal(${item.id}, ${item.student_id}, '${item.lecturer_ids_str || currentLecturerId}')">
                 Reschedule
             </button>`;
        } 

        html += `
        <div class="card-schedule">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <span class="badge-pill-custom">${item.type}</span>
                <span class="${item.statusClass} px-3 py-1 rounded-pill small fw-bold text-capitalize">
                    ${item.status}
                </span>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="label-text">Waktu</div>
                    <div class="value-text fs-5">${item.date}</div>
                    <div class="small text-muted"><i class="far fa-clock me-1"></i> ${item.time}</div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="label-text">Mahasiswa</div>
                    <div class="value-text text-primary">${item.student_name}</div>
                    <div class="small text-muted">${item.npm}</div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="label-text">Lokasi/Link</div>
                    <div class="value-text small text-break">${locationDisplay}</div>
                </div>
            </div>
            
            <div class="dashed-line"></div>
            
            <div class="row align-items-center">
                <div class="col-md-7 mb-2">
                    <div class="label-text">Catatan:</div>
                    <div class="text-muted small">${item.notes || "-"}</div>
                </div>
                <div class="col-md-5 text-end d-flex justify-content-end gap-2">
                    ${actionButtons}
                </div>
            </div>
        </div>
        `;
      });
      container.innerHTML = html;
    }

    async function markAsComplete(appId) {
        if(!confirm("Apakah bimbingan ini sudah selesai? Status akan diubah menjadi Completed.")) return;

        try {
            const res = await fetch(`/api/schedules/${appId}/complete`, {
                method: 'PUT'
            });
            const result = await res.json();

            if (result.success) {
                // alert(result.message); // Opsional
                fetchSchedules("all"); // Refresh tabel
            } else {
                alert("Gagal: " + result.message);
            }
        } catch (e) {
            console.error(e);
            alert("Terjadi kesalahan koneksi.");
        }
    }

    // --- LOGIC RESCHEDULE (UPDATED SMART SLOT) ---

    window.openRescheduleModal = function (appId, studentId, lecturerIds) {
      document.getElementById("rescheduleAppId").value = appId;
      document.getElementById("rescheduleStudentId").value = studentId;
      document.getElementById("rescheduleLecturerIds").value = lecturerIds; 
      
      // Reset UI
      document.getElementById("formReschedule").reset();
      document.getElementById("reschSlotContainer").innerHTML = '<small class="text-muted d-block text-center py-3">Pilih tanggal baru.</small>';
      document.getElementById("reschSelectedTime").value = "";

      const today = new Date().toISOString().split('T')[0];
      document.getElementById("newDate").min = today;
      
      new bootstrap.Modal(document.getElementById("rescheduleModal")).show();
    };

    // [BARU] Fetch Slot untuk Reschedule
    async function fetchRescheduleSlots() {
        const studentId = document.getElementById("rescheduleStudentId").value;
        const lecturerIds = document.getElementById("rescheduleLecturerIds").value;
        const date = document.getElementById("newDate").value;
        const container = document.getElementById("reschSlotContainer");

        if(!date) return;

        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

        try {
            const res = await fetch(`/api/schedules/available-slots?lecturerIds=${lecturerIds}&studentId=${studentId}&date=${date}`);
            const result = await res.json();

            if (result.success && result.data.length > 0) {
                let html = "";
                result.data.forEach((slot) => {
                    html += `
                    <div class="form-check border-bottom py-2 bg-white px-3">
                        <input class="form-check-input" type="radio" name="reschSlotRadio" id="rs_${slot.start}" value="${slot.value}" onchange="document.getElementById('reschSelectedTime').value = '${slot.value}'">
                        <label class="form-check-label w-100 fw-bold text-dark" for="rs_${slot.start}" style="cursor:pointer">
                            ${slot.value}
                        </label>
                    </div>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="text-center text-danger small py-3">Tidak ada jadwal yang cocok.</div>`;
            }
        } catch(e) {
            container.innerHTML = 'Error loading slots.';
        }
    }

    async function handleRescheduleSubmit(e) {
      e.preventDefault();

      const btnSubmit = e.target.querySelector('button[type="submit"]');
      const originalText = btnSubmit.innerText;
      
      const appId = document.getElementById("rescheduleAppId").value;
      const date = document.getElementById("newDate").value;
      const timeRange = document.getElementById("reschSelectedTime").value; 
      const reason = document.getElementById("rescheduleReason").value;

      if(!timeRange) {
          alert("Pilih waktu yang tersedia.");
          return;
      }

      btnSubmit.innerText = "Menyimpan...";
      btnSubmit.disabled = true;

      try {
        const response = await fetch(`/api/schedules/${appId}/reschedule`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
              date: date,
              timeRange: timeRange,
              reason: reason,
              userId: currentLecturerId,
              triggerBy: 'lecturer'
          }),
        });

        const result = await response.json();

        if (result.success) {
          alert("Jadwal berhasil diubah!");
          location.reload(); 
        } else {
          alert("Gagal: " + result.message);
        }
      } catch (error) {
        console.error(error);
        alert("Terjadi kesalahan saat menyimpan.");
      } finally {
        btnSubmit.innerText = originalText;
        btnSubmit.disabled = false;
      }
    }

    // ----------------------------------------------------------------
    // BAGIAN 3: FITUR CREATE SCHEDULE (SMART SLOT & RECURRING)
    // ----------------------------------------------------------------

    async function openCreateScheduleModal() {
        // Auto-select student if filtered
        const mainFilterVal = document.getElementById("student-filter").value;
        
        // Reset Form
        document.getElementById("createScheduleForm").reset();
        document.getElementById("slotContainer").innerHTML = '<small class="text-muted d-block text-center py-3">Pilih tanggal untuk melihat slot.</small>';
        document.getElementById("selectedTimeRange").value = "";
        document.getElementById("groupMode").style.display = "none";
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("inputStartDate").min = today;

        toggleFormType(); 
        toggleLocLabel();

        // Load Daftar Mahasiswa
        const select = document.getElementById("targetStudent");
        select.innerHTML = '<option value="">Memuat...</option>';

        try {
          const res = await fetch(`/api/lecturer/students/${currentLecturerId}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = '<option value="" disabled selected>- Pilih Mahasiswa -</option>';
            result.data.forEach((s) => {
              const isSelected = (mainFilterVal !== 'all' && mainFilterVal == s.user_id) ? 'selected' : '';
              html += `<option value="${s.user_id}" ${isSelected}>${s.name} (${s.npm})</option>`;
            });
            select.innerHTML = html;
            if(mainFilterVal !== 'all') onStudentChange();
          } else {
            select.innerHTML = '<option value="">Belum ada mahasiswa bimbingan.</option>';
          }
        } catch (e) { console.error(e); }

        new bootstrap.Modal(document.getElementById("createScheduleModal")).show();
    }

    async function onStudentChange() {
        const studentId = document.getElementById("targetStudent").value;
        const modeDiv = document.getElementById("groupMode");

        if (!studentId) return;

        // Reset Slot
        document.getElementById("slotContainer").innerHTML = '<small class="text-muted d-block text-center py-3">Pilih tanggal.</small>';
        document.getElementById("selectedTimeRange").value = "";

        try {
          const res = await fetch(`/api/lecturer/student-supervisors/${studentId}`);
          const result = await res.json();

          if (result.success) {
            currentSupervisors = result.data; 

            if (currentSupervisors.length > 1) {
              modeDiv.style.display = "block";
              const partner = currentSupervisors.find((s) => s.user_id !== currentLecturerId);
              const partnerName = partner ? partner.name : "Partner";

              const modeSelect = document.getElementById("scheduleMode");
              modeSelect.innerHTML = `
                  <option value="individual">Individual (Saya Saja)</option>
                  <option value="joint">Gabungan (Saya & ${partnerName})</option>
              `;
            } else {
              modeDiv.style.display = "none";
            }
          }
        } catch (e) { console.error(e); }

        if (document.getElementById("inputStartDate").value) {
          fetchAvailableSlots();
        }
    }

    async function fetchAvailableSlots() {
        const studentId = document.getElementById("targetStudent").value;
        const date = document.getElementById("inputStartDate").value;
        
        let mode = "individual";
        const modeDiv = document.getElementById("groupMode");
        if (modeDiv && modeDiv.style.display !== "none") {
            mode = document.getElementById("scheduleMode").value;
        }
        
        const container = document.getElementById("slotContainer");

        if (!studentId || !date) return;

        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

        // Tentukan ID Dosen
        let targetLecturerIds = [];
        if (mode === "individual") {
          targetLecturerIds = [currentLecturerId];
        } else {
          targetLecturerIds = currentSupervisors.map((s) => s.user_id);
        }

        try {
          const res = await fetch(
            `/api/schedules/available-slots?lecturerIds=${targetLecturerIds.join(",")}&studentId=${studentId}&date=${date}`
          );
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              html += `
              <div class="form-check border-bottom py-2 bg-white px-3">
                  <input class="form-check-input" type="radio" name="slotRadio" id="slot_${slot.start}" value="${slot.value}" onchange="selectSlot('${slot.value}')">
                  <label class="form-check-label w-100 fw-bold text-dark" for="slot_${slot.start}" style="cursor:pointer">
                      ${slot.value}
                  </label>
              </div>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `<div class="text-center text-danger small py-3">Tidak ada jadwal yang cocok.</div>`;
          }
        } catch (e) {
          container.innerHTML = '<div class="text-center text-danger small">Gagal memuat slot.</div>';
        }
    }

    window.selectSlot = function (val) {
      document.getElementById("selectedTimeRange").value = val;
    };

    /*
    async function handleCreateSchedule(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        
        const timeRange = document.getElementById("selectedTimeRange").value;
        if (!timeRange) { alert("Mohon pilih slot waktu yang tersedia."); return; }

        const startDateVal = document.getElementById("inputStartDate").value;
        const d = new Date(startDateVal);
        const dayOfWeek = d.getDay(); 

        const body = {
          lecturerId: currentLecturerId,
          studentId: document.getElementById("targetStudent").value,
          type: document.getElementById("inputType").value,
          startDate: startDateVal,
          endDate: document.getElementById("inputEndDate").value,
          dayOfWeek: dayOfWeek, 
          timeRange: timeRange, 
          frequency: 1, 
          mode: document.querySelector('input[name="inputMode"]:checked').value,
          location: document.getElementById("inputLocation").value,
          notes: document.getElementById("inputNotes").value,
        };

        btn.disabled = true;
        btn.innerText = "Memproses...";

        try {
          const res = await fetch("/api/schedules/lecturer-create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const result = await res.json();

          if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById("createScheduleModal")).hide();
            fetchSchedules("all");
          } else {
            alert(result.message);
          }
        } catch (err) {
          console.error(err);
          alert("Gagal koneksi ke server.");
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
    } */

    // public/js/lecturer_schedule.js

async function handleCreateSchedule(e) {
    e.preventDefault();

    const userSession = JSON.parse(localStorage.getItem("user_session"));
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerText;
    
    const timeRange = document.getElementById("selectedTimeRange").value;
    if (!timeRange) { alert("Mohon pilih slot waktu yang tersedia."); return; }

    const startDateVal = document.getElementById("inputStartDate").value;
    const d = new Date(startDateVal);
    const dayOfWeek = d.getDay(); 

    // [BARU] Ambil nilai frekuensi
    const freqVal = document.getElementById("inputFreqVal").value || 1;
    const freqUnit = document.getElementById("inputFreqUnit").value || 'week';

    const body = {
        lecturerId: currentLecturerId,
        studentId: document.getElementById("targetStudent").value,
        type: document.getElementById("inputType").value,
        startDate: startDateVal,
        endDate: document.getElementById("inputEndDate").value,
        dayOfWeek: dayOfWeek, 
        timeRange: timeRange, 
        
        // Kirim data frekuensi yang dinamis
        frequency: freqVal, 
        frequencyUnit: freqUnit, 

        mode: document.querySelector('input[name="inputMode"]:checked').value,
        location: document.getElementById("inputLocation").value,
        notes: document.getElementById("inputNotes").value,
    };

    btn.disabled = true;
    btn.innerText = "Memproses...";

    try {
        const res = await fetch("/api/schedules/lecturer-create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
        });
        const result = await res.json();

        if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById("createScheduleModal")).hide();
            fetchSchedules("all");
        } else {
            alert(result.message);
        }
    } catch (err) {
        console.error(err);
        alert("Gagal koneksi ke server.");
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

    function toggleFormType() {
    const type = document.getElementById("inputType").value;
    const isRecurring = type === "recurring";
    
    // Tampilkan Input Tanggal Selesai
    document.getElementById("groupEndDate").style.display = isRecurring ? "block" : "none";
    document.getElementById("inputEndDate").required = isRecurring;

    // Tampilkan Input Frekuensi Detail (Angka + Unit)
    document.getElementById("groupFrequency").style.display = isRecurring ? "block" : "none";
}

    function toggleLocLabel() {
        const isOnline = document.getElementById("modeOnline").checked;
        const label = document.getElementById("labelLoc");
        const input = document.getElementById("inputLocation");
        if (isOnline) {
          label.innerText = "Link Meeting";
          input.placeholder = "https://meet.google.com/...";
        } else {
          label.innerText = "Ruangan / Lokasi";
          input.placeholder = "Contoh: R. 9212";
        }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "/login";
    }
  </script>
</body>
</html>