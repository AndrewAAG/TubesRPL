<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Kalender Dosen - Cek Ketersediaan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <style>
      #calendar {
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        min-height: 600px;
      }
      .card-filter {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        height: 100%;
      }
      
      .fc-day-today {
        background-color: #f0f7ff !important;
      }
      .fc-daygrid-day {
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .fc-daygrid-day:hover {
        background-color: #f8f9fa;
      }

      /* Tampilan Slot Statis (Read Only) */
      .slot-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #495057;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        text-align: center;
        transition: all 0.2s;
      }
      .slot-item:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="fw-bold text-primary mb-1">Cek Ketersediaan</h2>

              <div class="d-flex align-items-center gap-3">
                <div class="notification-circle" id="bell-icon">
                    <i class="fas fa-bell fa-lg text-secondary"></i>
                    <span class="badge-dot"></span>
                </div>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-lg-8">
                <div id="calendar"></div>
              </div>

              <div class="col-lg-4">
                <div class="card-filter">
                  <h5 class="fw-bold mb-3"><i class="fas fa-filter me-2 text-primary"></i>Filter Ketersediaan</h5>

                  <div class="mb-3">
                    <label class="small text-muted fw-bold mb-2">Cek Kecocokan Dengan:</label>
                    <select id="studentSelect" class="form-select rounded-pill shadow-sm">
                      <option value="" selected>Loading...</option>
                    </select>
                  </div>

                  <div id="modeContainer" class="mb-4" style="display: none">
                    <label class="small text-muted fw-bold mb-2">Mode Bimbingan</label>
                    <select id="modeSelect" class="form-select rounded-pill shadow-sm bg-light border-0">
                      <option value="individual">Bimbingan Individual (Saya Saja)</option>
                      <option value="joint" class="fw-bold text-primary">Bimbingan Gabungan</option>
                    </select>
                    <small class="text-muted fst-italic mt-1 d-block" style="font-size: 0.75rem"> 
                        *Mode Gabungan akan mencari irisan waktu kosong antara Anda, Partner, dan Mahasiswa.
                    </small>
                  </div>

                  <hr class="dashed-line my-4" />

                  <div id="slotResultContainer" style="display: none">
                    <h6 class="fw-bold mb-3 text-dark">
                        <i class="far fa-clock me-2 text-warning"></i>
                        Waktu Tersedia: <br />
                        <span id="selectedDateLabel" class="text-primary small"></span>
                    </h6>

                    <div id="slotsWrapper" class="d-flex flex-column" style="max-height: 400px; overflow-y: auto">
                        </div>
                  </div>

                  <div id="emptyStateContainer" class="text-center py-5 text-muted">
                    <i class="far fa-calendar-check fa-3x mb-3 opacity-25"></i>
                    <p class="small">Pilih mahasiswa & klik tanggal untuk melihat waktu yang cocok.</p>
                  </div>
                </div>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/notification.js"></script>
    <script>
      let calendar;
      let selectedDateStr = "";
      let currentSupervisors = []; 

      document.addEventListener("DOMContentLoaded", async () => {
        // 1. Cek Sesi
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession || userSession.role !== "lecturer") {
          window.location.href = "/login";
          return;
        }

        // 2. Init Calendar
        initCalendar();

        // 3. Load Daftar Mahasiswa Saya
        await loadMyStudents(userSession.user_id);

        // 4. Listeners
        document.getElementById("studentSelect").addEventListener("change", onStudentChange);
        document.getElementById("modeSelect").addEventListener("change", () => {
          if (selectedDateStr) fetchSlots(selectedDateStr);
        });
      });

      function initCalendar() {
        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          headerToolbar: { left: "prev,next today", center: "title", right: "" }, // Hapus tombol view kanan
          locale: "id",
          firstDay: 1,
          selectable: true,
          height: "auto",

          dateClick: function (info) {
            // Visual Highlight
            document.querySelectorAll(".fc-daygrid-day").forEach((el) => (el.style.backgroundColor = ""));
            info.dayEl.style.backgroundColor = "#e7f1ff";

            selectedDateStr = info.dateStr;

            const d = new Date(selectedDateStr);
            const dateLabel = d.toLocaleDateString("id-ID", { weekday: "long", day: "numeric", month: "long", year: "numeric" });
            document.getElementById("selectedDateLabel").innerText = dateLabel;

            fetchSlots(selectedDateStr);
          },
        });
        calendar.render();
      }

      // --- 1. LOAD MAHASISWA ---
      async function loadMyStudents(lecturerId) {
        try {
          const res = await fetch(`/api/lecturer/students-list/${lecturerId}`);
          const result = await res.json();

          const select = document.getElementById("studentSelect");
          let html = '<option value="">- Pilih Mahasiswa -</option>';

          if (result.success) {
            result.data.forEach((s) => {
              html += `<option value="${s.student_id}">${s.name} (${s.npm})</option>`;
            });
          }
          select.innerHTML = html;
        } catch (e) {
          console.error(e);
          select.innerHTML = '<option value="">Gagal memuat data</option>';
        }
      }

      // --- 2. DETEKSI DOUBLE TA & RENDER OPSI ---
      async function onStudentChange() {
        const studentId = this.value;
        const modeContainer = document.getElementById("modeContainer");
        const modeSelect = document.getElementById("modeSelect");
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const myId = userSession.user_id;

        // Reset UI
        document.getElementById("emptyStateContainer").style.display = "block";
        document.getElementById("slotResultContainer").style.display = "none";
        modeContainer.style.display = "none";
        selectedDateStr = "";
        
        // Hapus highlight kalender saat ganti user
        if(calendar) {
            document.querySelectorAll(".fc-daygrid-day").forEach((el) => (el.style.backgroundColor = ""));
        }

        if (!studentId) return;

        try {
          const res = await fetch(`/api/lecturer/student-supervisors/${studentId}`);
          const result = await res.json();

          if (result.success) {
            currentSupervisors = result.data;

            if (currentSupervisors.length > 1) {
              const partner = currentSupervisors.find((s) => s.user_id !== myId);
              const partnerName = partner ? partner.name : "Dosen Lain";

              modeContainer.style.display = "block";
              modeSelect.innerHTML = `
                    <option value="individual">Hanya Saya & Mahasiswa</option>
                    <option value="joint" class="fw-bold text-primary">Gabungan (Saya, ${partnerName} & Mahasiswa)</option>
                `;
            } else {
              modeContainer.style.display = "none";
              modeSelect.innerHTML = `<option value="individual" selected>Individual</option>`;
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      // --- 3. FETCH SLOTS (READ ONLY) ---
      async function fetchSlots(date) {
        const container = document.getElementById("slotsWrapper");
        const resultDiv = document.getElementById("slotResultContainer");
        const emptyDiv = document.getElementById("emptyStateContainer");

        const studentId = document.getElementById("studentSelect").value;
        const mode = document.getElementById("modeSelect").value;
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const myId = userSession.user_id;

        if (!studentId) {
          container.innerHTML = '<div class="text-center text-danger small p-3">Silakan pilih mahasiswa terlebih dahulu.</div>';
          return;
        }

        // UI Loading
        emptyDiv.style.display = "none";
        resultDiv.style.display = "block";
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small mt-2">Mengecek jadwal...</div></div>';

        // Tentukan ID siapa saja yang dicek bentroknya
        let targetLecturerIds = [];
        if (mode === "individual") {
          targetLecturerIds = [myId];
        } else {
          targetLecturerIds = currentSupervisors.map((s) => s.user_id);
        }
        const idsParam = targetLecturerIds.join(",");

        try {
          const res = await fetch(`/api/schedules/available-slots?lecturerIds=${idsParam}&studentId=${studentId}&date=${date}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              // Render DIV statis
              html += `
                <div class="slot-item">
                    <i class="far fa-clock me-2 text-primary"></i> ${slot.value}
                </div>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="far fa-times-circle fa-2x text-muted mb-2"></i>
                    <p class="small text-muted mb-0">Tidak ada jadwal yang cocok.</p>
                </div>`;
          }
        } catch (e) {
          container.innerHTML = '<div class="text-center text-danger small">Gagal memuat slot.</div>';
        }
      }
    </script>
  </body>
</html>