<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Kalender Dosen - Bimbingan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <style>
      /* Reuse style dari student calendar */
      #calendar {
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        min-height: 600px;
      }
      .card-filter {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        height: 100%;
      }
      .btn-slot {
        border: 1px solid #dee2e6;
        background: #fff;
        color: #333;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn-slot:hover,
      .btn-slot.active {
        background: #e7f1ff;
        border-color: #0d6efd;
        color: #0d6efd;
        font-weight: 600;
      }
      .fc-day-today {
        background-color: #f0f7ff !important;
      }
      .fc-event {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="fw-bold text-primary mb-1">Kalender Bimbingan</h2>
              <div class="d-flex align-items-center gap-3">
                <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3"><i class="fas fa-sign-out-alt"></i> Logout</button>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-lg-8">
                <div id="calendar"></div>
              </div>

              <div class="col-lg-4">
                <div class="card-filter">
                  <h5 class="fw-bold mb-3"><i class="fas fa-user-graduate me-2 text-primary"></i>Cek Jadwal Mahasiswa</h5>

                  <div class="mb-3">
                    <label class="small text-muted fw-bold mb-2">Pilih Mahasiswa</label>
                    <select id="studentSelect" class="form-select rounded-pill shadow-sm">
                      <option value="" selected>Loading...</option>
                    </select>
                  </div>

                  <div id="modeContainer" class="mb-4" style="display: none">
                    <label class="small text-muted fw-bold mb-2">Mode Bimbingan</label>
                    <select id="modeSelect" class="form-select rounded-pill shadow-sm bg-light border-0">
                      <option value="individual">Bimbingan Individual (Saya Saja)</option>
                      <option value="joint" class="fw-bold text-primary">★ Bimbingan Gabungan (Joint)</option>
                    </select>
                    <small class="text-muted fst-italic mt-1 d-block" style="font-size: 0.75rem"> Mahasiswa ini memiliki 2 pembimbing. </small>
                  </div>

                  <hr class="dashed-line my-4" />

                  <div id="slotResultContainer" style="display: none">
                    <h6 class="fw-bold mb-3 text-dark"><i class="far fa-clock me-2 text-warning"></i>Slot Tersedia: <br /><span id="selectedDateLabel" class="text-primary small"></span></h6>

                    <div id="slotsWrapper" class="d-grid gap-2" style="max-height: 300px; overflow-y: auto"></div>

                    <div class="mt-3">
                      <button id="btnCreateSchedule" class="btn btn-primary-custom w-100 rounded-pill fw-bold" disabled onclick="createScheduleByLecturer()">Tetapkan Jadwal Ini</button>
                    </div>
                  </div>

                  <div id="emptyStateContainer" class="text-center py-5 text-muted">
                    <i class="far fa-calendar-check fa-3x mb-3 opacity-25"></i>
                    <p class="small">Pilih mahasiswa & klik tanggal untuk melihat waktu yang cocok.</p>
                  </div>
                </div>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
      // public/js/lecturer_calendar.js

      let calendar;
      let selectedDateStr = "";
      let selectedSlot = "";
      let currentSupervisors = []; // Menyimpan data pembimbing dari mahasiswa terpilih

      document.addEventListener("DOMContentLoaded", async () => {
        // 1. Cek Sesi
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession || userSession.role !== "lecturer") {
          window.location.href = "/login";
          return;
        }

        // 2. Init Calendar
        initCalendar();

        // 3. Load Daftar Mahasiswa Saya
        await loadMyStudents(userSession.user_id);

        // 4. Listeners
        document.getElementById("studentSelect").addEventListener("change", onStudentChange);
        document.getElementById("modeSelect").addEventListener("change", () => {
          // Refresh slot jika mode diganti & tanggal sudah dipilih
          if (selectedDateStr) fetchSlots(selectedDateStr);
        });
      });

      function initCalendar() {
        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth" },
          locale: "id",
          firstDay: 1,
          selectable: true,
          height: "auto",

          dateClick: function (info) {
            // Visual Highlight
            document.querySelectorAll(".fc-day").forEach((el) => (el.style.backgroundColor = ""));
            info.dayEl.style.backgroundColor = "#e7f1ff";

            selectedDateStr = info.dateStr;

            const d = new Date(selectedDateStr);
            const dateLabel = d.toLocaleDateString("id-ID", { weekday: "long", day: "numeric", month: "long", year: "numeric" });
            document.getElementById("selectedDateLabel").innerText = dateLabel;

            fetchSlots(selectedDateStr);
          },
        });
        calendar.render();
      }

      // --- 1. LOAD MAHASISWA ---
      async function loadMyStudents(lecturerId) {
        try {
          const res = await fetch(`/api/lecturer/students-list/${lecturerId}`);
          const result = await res.json();

          const select = document.getElementById("studentSelect");
          let html = '<option value="">- Pilih Mahasiswa -</option>';

          if (result.success) {
            result.data.forEach((s) => {
              html += `<option value="${s.student_id}">${s.name} (${s.npm})</option>`;
            });
          }
          select.innerHTML = html;
        } catch (e) {
          console.error(e);
        }
      }

      // --- 2. DETEKSI DOUBLE TA & RENDER OPSI ---
      async function onStudentChange() {
        const studentId = this.value;
        const modeContainer = document.getElementById("modeContainer");
        const modeSelect = document.getElementById("modeSelect");
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const myId = userSession.user_id;

        // Reset UI
        document.getElementById("emptyStateContainer").style.display = "block";
        document.getElementById("slotResultContainer").style.display = "none";
        modeContainer.style.display = "none";
        selectedDateStr = "";
        document.querySelectorAll(".fc-day").forEach((el) => (el.style.backgroundColor = ""));

        if (!studentId) return;

        try {
          // Ambil data semua pembimbing mahasiswa ini
          const res = await fetch(`/api/lecturer/student-supervisors/${studentId}`);
          const result = await res.json();

          if (result.success) {
            currentSupervisors = result.data;

            // Cek apakah ada partner (jumlah supervisor > 1)
            if (currentSupervisors.length > 1) {
              // Cari nama partner
              const partner = currentSupervisors.find((s) => s.user_id !== myId);
              const partnerName = partner ? partner.name : "Dosen Lain";

              // Tampilkan Dropdown Mode dengan 2 Opsi Spesifik
              modeContainer.style.display = "block";
              modeSelect.innerHTML = `
                    <option value="individual">
                        Hanya Saya & Mahasiswa
                    </option>
                    <option value="joint" class="fw-bold text-primary">
                        Gabungan (Saya, ${partnerName} & Mahasiswa)
                    </option>
                `;
            } else {
              // Jika cuma 1 pembimbing (saya saja), sembunyikan mode select
              modeContainer.style.display = "none";
              modeSelect.innerHTML = `<option value="individual" selected>Individual</option>`;
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      // --- 3. FETCH SLOTS (LOGIKA PENTING) ---
      async function fetchSlots(date) {
        const container = document.getElementById("slotsWrapper");
        const resultDiv = document.getElementById("slotResultContainer");
        const emptyDiv = document.getElementById("emptyStateContainer");

        const studentId = document.getElementById("studentSelect").value;
        const mode = document.getElementById("modeSelect").value;
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const myId = userSession.user_id;

        if (!studentId) {
          alert("Pilih mahasiswa dulu.");
          return;
        }

        // UI Loading
        emptyDiv.style.display = "none";
        resultDiv.style.display = "block";
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small mt-2">Mencocokkan jadwal...</div></div>';
        document.getElementById("btnCreateSchedule").disabled = true;

        // --- LOGIKA PENENTUAN ID ---
        let targetLecturerIds = [];

        if (mode === "individual") {
          // CASE 1: Hanya Saya + Mahasiswa
          // Backend akan mencari irisan jadwal (Saya) ∩ (Mahasiswa)
          targetLecturerIds = [myId];
        } else {
          // CASE 2: Saya + Partner + Mahasiswa
          // Backend akan mencari irisan jadwal (Saya) ∩ (Partner) ∩ (Mahasiswa)
          targetLecturerIds = currentSupervisors.map((s) => s.user_id);
        }

        const idsParam = targetLecturerIds.join(",");

        try {
          const res = await fetch(`/api/schedules/available-slots?lecturerIds=${idsParam}&studentId=${studentId}&date=${date}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              html += `
                <button class="btn btn-slot w-100 mb-2 py-2" onclick="selectSlot(this, '${slot.value}')">
                    ${slot.value}
                </button>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `<div class="text-center py-4 small text-muted">Tidak ada jadwal yang cocok.</div>`;
          }
        } catch (e) {
          container.innerHTML = '<div class="text-center text-danger small">Gagal memuat slot.</div>';
        }
      }

      function selectSlot(btn, timeRange) {
        document.querySelectorAll(".btn-slot").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        selectedSlot = timeRange;
        document.getElementById("btnCreateSchedule").disabled = false;
      }

      function createScheduleByLecturer() {
        const studentId = document.getElementById("studentSelect").value;
        alert(`Jadwal Terpilih:\nTanggal: ${selectedDateStr}\nJam: ${selectedSlot}\n\n(Fitur Simpan akan diimplementasikan selanjutnya)`);
      }

      function logout() {
        localStorage.clear();
        window.location.href = "/login";
      }
    </script>
  </body>
</html>
