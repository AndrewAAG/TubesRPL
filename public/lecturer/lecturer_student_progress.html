<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Detail Progress Mahasiswa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      /* Kita reuse class .card-standard dari style.css agar sama persis dengan Student */
      /* List Item Styling agar mirip screenshot */
      .list-item-row:last-child {
        border-bottom: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-start mb-4">
              <div>
                <div class="text-primary fw-bold mb-1" style="font-size: 1.1rem">Daftar Mahasiswa</div>
                <h2 class="fw-bold text-dark mb-0" id="studentName">Loading...</h2>
                <p class="text-muted" id="studentNpm">NPM: -</p>
              </div>

              <div class="d-flex align-items-center gap-3">
                <button onclick="history.back()" class="btn btn-outline-secondary btn-sm rounded-pill px-4 fw-bold"><i class="fas fa-arrow-left me-2"></i> Kembali</button>
              </div>
            </div>

            <div class="card-standard mb-4 p-4" style="border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); border-radius: 20px">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Status Kelayakan Sidang</h5>
                <span id="statusBadge" class="badge rounded-pill bg-secondary text-white px-4 py-2 fs-6 fw-bold"> Loading... </span>
              </div>

              <hr class="dashed-line my-3" />

              <div id="progress-bars-wrapper"></div>
            </div>

            <div class="row g-4">
              <div class="col-md-6">
                <div class="card-blue-header h-100">
                  <div class="card-header-custom"><i class="fas fa-history me-2"></i> Riwayat Bimbingan</div>
                  <div class="card-body-custom bg-white" id="history-container"></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card-blue-header h-100">
                  <div class="card-header-custom"><i class="fas fa-clipboard-list me-2"></i> Tugas Dari Dosen</div>
                  <div class="card-body-custom bg-white" id="tasks-container"></div>
                </div>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get("id");

        if (!studentId) {
          alert("Mahasiswa tidak ditemukan");
          window.history.back();
          return;
        }

        fetchStudentDetail(studentId);
      });

      async function fetchStudentDetail(studentId) {
        // Loading state sederhana di wrapper bar
        document.getElementById("progress-bars-wrapper").innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

        try {
          const response = await fetch(`/api/progress/student/${studentId}`);
          const result = await response.json();

          if (result.success) {
            renderPage(result.data);
          } else {
            alert(result.message);
          }
        } catch (error) {
          console.error(error);
          alert("Gagal mengambil data.");
        }
      }

      function renderPage(data) {
        // 1. Header Info Mahasiswa
        document.getElementById("studentName").textContent = data.student_info.name;
        document.getElementById("studentNpm").textContent = `NPM: ${data.student_info.npm}`;

        // 2. Render Status Badge (Sama seperti Student)
        renderStatusBadge(data.progress);

        // 3. Render Progress Bars (Sama seperti Student)
        renderProgressBars(data.progress.bars);

        // 4. Render History & Tasks
        renderHistory(data.history);
        renderTasks(data.tasks);
      }

      // --- FUNGSI RENDER KOMPONEN ---

      function renderStatusBadge(progress) {
        const badge = document.getElementById("statusBadge");
        if (!badge) return;

        badge.textContent = progress.status_text;
        badge.className = "badge rounded-pill px-4 py-2 fs-6 fw-bold"; // Reset class

        if (progress.status_color === "success") {
          badge.classList.add("bg-success-subtle", "text-success");
        } else if (progress.status_color === "danger") {
          badge.classList.add("bg-danger-subtle", "text-danger");
        } else {
          badge.classList.add("bg-warning-subtle", "text-warning");
        }
      }

      function renderProgressBars(bars) {
        const container = document.getElementById("progress-bars-wrapper");
        if (!container) return;

        let html = "";
        bars.forEach((bar, index) => {
          // Separator jika lebih dari 1 bar
          const separator = index > 0 ? '<hr class="dashed-line my-4">' : "";
          const barColor = bar.percent >= 100 ? "#198754" : "#0d6efd"; // Hijau jika penuh

          html += `
          ${separator}
          <div>
              <div class="d-flex justify-content-between align-items-end mb-2">
                  <div>
                      <h6 class="fw-bold mb-0 text-dark">${bar.label}</h6>
                      <small class="text-muted" style="font-size: 0.75rem;">Target: ${bar.target} Pertemuan</small>
                  </div>
                  <span class="badge bg-light text-dark border">${bar.current}/${bar.target}</span>
              </div>
              
              <div class="progress" style="height: 15px; border-radius: 10px; background-color: #f1f3f5; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" 
                       role="progressbar" 
                       style="width: ${bar.percent}%; background-color: ${barColor}; border-radius: 10px;" 
                       aria-valuenow="${bar.percent}" aria-valuemin="0" aria-valuemax="100">
                  </div>
              </div>
          </div>
      `;
        });
        container.innerHTML = html;
      }

      function renderHistory(history) {
        const container = document.getElementById("history-container");
        if (history.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-3 small">Belum ada riwayat.</div>';
          return;
        }

        let html = "";
        history.forEach((item) => {
          html += `
        <div class="list-item-row border-bottom py-3 px-4">
            <div class="fw-bold text-dark mb-1" style="font-size:0.95rem;">
                <i class="far fa-calendar-check me-2 text-primary"></i>${item.date}
            </div>
            <div class="text-muted small ps-4">${item.topic}</div>
        </div>`;
        });
        container.innerHTML = html;
      }

      function renderTasks(tasks) {
        const container = document.getElementById("tasks-container");
        if (tasks.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-3 small">Tidak ada tugas.</div>';
          return;
        }

        let html = "";
        tasks.forEach((task) => {
          let badgeHtml = "";
          // Mapping warna badge agar konsisten
          if (task.status === "Completed") {
            badgeHtml = `<span class="badge bg-success-subtle text-success rounded-pill px-3">Completed</span>`;
          } else if (task.status === "In Progress") {
            badgeHtml = `<span class="badge bg-info-subtle text-info fw-bold rounded-pill px-3">In Progress</span>`;
          } else {
            badgeHtml = `<span class="badge bg-danger-subtle text-danger rounded-pill px-3">Incomplete</span>`;
          }

          html += `
        <div class="list-item-row d-flex justify-content-between align-items-center border-bottom py-3 px-4">
            <div class="text-secondary fw-medium" style="font-size:0.95rem;">${task.name}</div>
            <div>${badgeHtml}</div>
        </div>`;
        });
        container.innerHTML = html;
      }
    </script>
  </body>
</html>
