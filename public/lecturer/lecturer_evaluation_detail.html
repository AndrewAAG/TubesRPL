<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Detail Evaluasi - Dosen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-5">
              <div>
                <h2 class="fw-bold text-primary mb-1">Input Hasil Bimbingan</h2>
                <p class="text-muted small">Mahasiswa: <span id="studentNameDisplay" class="fw-bold text-dark">-</span></p>
              </div>
              <div class="d-flex align-items-center gap-3">
                <button onclick="history.back()" class="btn btn-outline-secondary btn-sm rounded-pill px-3"><i class="fas fa-arrow-left me-2"></i> Kembali</button>
              </div>
            </div>

            <div class="card-blue-header mb-4">
              <div class="card-header-custom d-flex justify-content-between">
                <span>Catatan Bimbingan (Notulen)</span>
                <small class="text-white-50"><i class="fas fa-pen"></i> Mode Edit</small>
              </div>
              <div class="card-body-custom p-4 bg-white">
                <textarea id="notesInput" class="form-control border-0 bg-light p-3" rows="5" style="border-radius: 15px; resize: none" placeholder="Tuliskan ringkasan bimbingan di sini..."></textarea>

                <div class="text-end mt-3">
                  <button id="btnSaveNote" class="btn btn-primary-custom rounded-pill px-4 btn-sm">Simpan Catatan</button>
                </div>
              </div>
            </div>

            <div class="card-blue-header mb-4">
              <div class="card-header-custom">Tugas & Action Items</div>
              <div class="card-body-custom bg-white">
                <div id="tasks-container" class="mb-3"></div>

                <div class="p-4 bg-light border-top">
                  <h6 class="fw-bold text-primary mb-3"><i class="fas fa-plus-circle"></i> Tambah Tugas Baru</h6>
                  <div class="row g-2">
                    <div class="col-md-7">
                      <input type="text" id="newTaskDesc" class="form-control rounded-pill border-0 shadow-sm px-3" placeholder="Deskripsi Tugas (Misal: Revisi Bab 1)" />
                    </div>
                    <div class="col-md-3">
                      <input type="text" id="newTaskDate" class="form-control rounded-pill border-0 shadow-sm px-3" placeholder="Tenggat Waktu" onfocus="(this.type='date')" onblur="(this.type='text')" />
                    </div>
                    <div class="col-md-2 d-grid">
                      <button id="btnAddTask" class="btn btn-success rounded-pill shadow-sm fw-bold">Tambah</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/sidebar.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const appId = urlParams.get("id");

      document.addEventListener("DOMContentLoaded", () => {
        if (!appId) {
          alert("ID Error");
          window.history.back();
          return;
        }

        fetchDetail();

        // Event Listener Simpan Catatan
        document.getElementById("btnSaveNote").addEventListener("click", saveNote);

        // Event Listener Tambah Tugas
        document.getElementById("btnAddTask").addEventListener("click", addTask);
      });

      async function fetchDetail() {
        try {
          const response = await fetch(`/api/evaluations/detail/${appId}`);
          const result = await response.json();

          if (result.success) {
            renderPage(result.data);
          }
        } catch (e) {
          console.error(e);
        }
      }

      function renderPage(data) {
        document.getElementById("studentNameDisplay").innerText = data.student_name || "Mahasiswa";
        document.getElementById("notesInput").value = data.notes || "";

        // Render List Tugas
        const container = document.getElementById("tasks-container");
        if (!data.tasks || data.tasks.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-muted small">Belum ada tugas yang diberikan.</div>';
        } else {
          let html = "";
          data.tasks.forEach((task) => {
            // Logic Badge Status
            let statusBadge = "";
            if (task.status === "completed") statusBadge = '<span class="badge bg-success rounded-pill">Selesai</span>';
            else if (task.status === "in_progress") statusBadge = '<span class="badge bg-warning text-dark rounded-pill">Proses</span>';
            else statusBadge = '<span class="badge bg-secondary rounded-pill">Pending</span>';

            // PERBAIKAN FORMAT TANGGAL (Safe Date Formatting)
            let dueDateDisplay = "-";
            if (task.due_date) {
              // Konversi ke object Date lalu format ke Indonesia
              const dateObj = new Date(task.due_date);
              if (!isNaN(dateObj)) {
                dueDateDisplay = dateObj.toLocaleDateString("id-ID", {
                  day: "numeric",
                  month: "long",
                  year: "numeric",
                });
              }
            }

            html += `
            <div class="list-item-row d-flex justify-content-between align-items-center px-4 py-3">
                <div>
                    <div class="fw-bold text-dark">${task.description}</div>
                    <small class="text-muted">
                        <i class="far fa-calendar me-1"></i> Due: <span class="fw-bold text-primary">${dueDateDisplay}</span>
                    </small>
                </div>
                <div>${statusBadge}</div>
            </div>`;
          });
          container.innerHTML = html;
        }
      }

      // --- LOGIC SIMPAN ---

      async function saveNote() {
        const note = document.getElementById("notesInput").value;
        const btn = document.getElementById("btnSaveNote");

        btn.innerText = "Menyimpan...";
        btn.disabled = true;

        try {
          const res = await fetch("/api/evaluations/note", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ appId, summary: note }),
          });
          const result = await res.json();
          if (result.success) alert("Catatan berhasil disimpan!");
          else alert("Gagal menyimpan");
        } catch (e) {
          alert("Error koneksi");
        } finally {
          btn.innerText = "Simpan Catatan";
          btn.disabled = false;
        }
      }

      async function addTask() {
        const desc = document.getElementById("newTaskDesc").value;
        const date = document.getElementById("newTaskDate").value;

        if (!desc) return alert("Deskripsi tugas tidak boleh kosong");

        try {
          const res = await fetch("/api/evaluations/task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ appId, description: desc, dueDate: date }),
          });
          const result = await res.json();
          if (result.success) {
            // Reset form dan refresh data
            document.getElementById("newTaskDesc").value = "";
            document.getElementById("newTaskDate").value = "";
            fetchDetail(); // Reload list tugas
          } else {
            alert(result.message);
          }
        } catch (e) {
          alert("Error koneksi");
        }
      }
    </script>
  </body>
</html>
