<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender - Student</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .calendar-container {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .calendar-header-month {
            text-align: center;
            color: white;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .calendar-grid {
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        .week-header {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .day-number {
            display: block;
            font-size: 20px;
            color: #0d6efd;
            margin-bottom: 3px;
        }

        .time-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
        }

        .time-label {
            padding: 20px 10px;
            text-align: right;
            font-weight: 500;
            color: #6c757d;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .day-cell {
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            min-height: 60px;
        }

        .event {
            position: absolute;
            left: 5px;
            right: 5px;
            border-radius: 8px;
            padding: 8px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }

        .event:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .event-available {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        }

        .event-booked {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            cursor: not-allowed;
        }

        .event-my-booking {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        }

        .event-unavailable {
            background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
            cursor: not-allowed;
        }

        .event-time {
            display: block;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .event-title {
            display: block;
            font-size: 11px;
            opacity: 0.95;
        }

        .event-lecturer {
            display: block;
            font-size: 10px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: white;
            border: none;
            color: #0d6efd;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #e7f1ff;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 13px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .week-header {
                grid-template-columns: 60px repeat(5, 1fr);
            }

            .time-grid {
                grid-template-columns: 60px repeat(5, 1fr);
            }

            .day-header {
                padding: 8px 5px;
                font-size: 11px;
            }

            .day-number {
                font-size: 16px;
            }

            .time-label {
                padding: 15px 5px;
                font-size: 11px;
            }

            .event {
                font-size: 10px;
                padding: 5px;
            }

            .calendar-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

            <div class="col-md-9 col-lg-10 h-100 p-0 position-relative">
                <div class="main-content-scrollable">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold text-primary mb-1">Kalender</h2>
                            <p class="text-muted small">Jadwal bimbingan yang tersedia</p>
                        </div>

                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-outline-danger btn-sm rounded-pill px-3 d-flex align-items-center gap-2">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>

                            <div class="notification-circle">
                                <i class="fas fa-bell fa-lg text-secondary"></i>
                                <span class="badge-dot">2</span>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div class="calendar-navigation">
                            <button class="nav-btn" onclick="previousWeek()">
                                <i class="fas fa-chevron-left"></i> Minggu Sebelumnya
                            </button>
                            <div class="calendar-header-month" id="current-month">Oktober</div>
                            <button class="nav-btn" onclick="nextWeek()">
                                Minggu Berikutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div class="calendar-grid" id="calendar-grid">
                            <div class="text-center py-5">
                                <div class="spinner-border text-white" role="status"></div>
                                <div class="mt-2 text-white small">Memuat kalender...</div>
                            </div>
                        </div>

                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-box" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);"></div>
                                <span>Tersedia</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);"></div>
                                <span>Booking Anda</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);"></div>
                                <span>Sudah Dibooking</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box" style="background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);"></div>
                                <span>Tidak Tersedia</span>
                            </div>
                        </div>
                    </div>

                    <div style="height: 50px"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Booking -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Booking Jadwal Bimbingan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tanggal & Waktu</label>
                        <p id="modal-datetime" class="text-muted"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Dosen Pembimbing</label>
                        <p id="modal-lecturer" class="text-muted"></p>
                    </div>
                    <div class="mb-3">
                        <label for="booking-mode" class="form-label fw-bold">Mode Bimbingan</label>
                        <select class="form-select" id="booking-mode" onchange="toggleLocationInput()">
                            <option value="offline">Offline (Ruangan)</option>
                            <option value="online">Online (Link Meeting)</option>
                        </select>
                    </div>
                    <div class="mb-3" id="location-container">
                        <label for="booking-location" class="form-label fw-bold">Ruangan / Link Meeting</label>
                        <input type="text" class="form-control" id="booking-location" placeholder="Contoh: Ruang 301">
                    </div>
                    <div class="mb-3">
                        <label for="booking-notes" class="form-label fw-bold">Catatan (Opsional)</label>
                        <textarea class="form-control" id="booking-notes" rows="3" placeholder="Topik yang ingin dibahas..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBooking()">Booking Sekarang</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="sidebar.js"></script>
    <script>
        let currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1);
        let scheduleData = {};
        let selectedSchedule = null;
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));

        async function fetchCalendarData() {
            const grid = document.getElementById('calendar-grid');
            const userSession = JSON.parse(localStorage.getItem('user_session'));

            if (!userSession || !userSession.user_id) {
                alert('Sesi habis, silakan login kembali.');
                window.location.href = '../login.html';
                return;
            }

            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 4);

            const startDate = currentWeekStart.toISOString().split('T')[0];
            const endDate = weekEnd.toISOString().split('T')[0];

            try {
                const response = await fetch(`/api/schedules/calendar/${userSession.user_id}?start_date=${startDate}&end_date=${endDate}`);
                const result = await response.json();

                if (result.success) {
                    scheduleData = result.data;
                    renderCalendar();
                } else {
                    grid.innerHTML = `<div class="text-center text-white py-5">${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error fetching calendar:', error);
                grid.innerHTML = `<div class="text-center text-white py-5">Gagal terhubung ke server.</div>`;
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYear = currentWeekStart.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            document.getElementById('current-month').textContent = monthYear;

            const weekDates = [];
            for (let i = 0; i < 5; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                weekDates.push(date);
            }

            const dayNames = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
            const timeSlots = ['07.00', '08.00', '09.00', '10.00', '11.00', '12.00', '13.00', '14.00', '15.00', '16.00', '17.00', '18.00'];

            let html = '<div class="week-header"><div class="day-header"></div>';
            
            weekDates.forEach((date, i) => {
                html += `
                    <div class="day-header">
                        <span class="day-number">${date.getDate()}</span>
                        ${dayNames[i]}
                    </div>
                `;
            });
            html += '</div>';

            html += '<div class="time-grid">';
            timeSlots.forEach(time => {
                html += `<div class="time-label">${time}</div>`;
                
                weekDates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const events = scheduleData[dateStr] || [];
                    
                    html += '<div class="day-cell">';
                    
                    events.forEach(event => {
                        if (event.start_time.startsWith(time.substring(0, 2))) {
                            const duration = calculateDuration(event.time);
                            const eventClass = `event-${event.type}`;
                            const clickable = event.type === 'available' ? `onclick="openBookingModal('${dateStr}', '${event.schedule_id}')"` : '';
                            
                            html += `
                                <div class="event ${eventClass}" style="height: ${duration}px;" ${clickable}>
                                    <span class="event-time">${event.time}</span>
                                    <span class="event-title">${event.title}</span>
                                    ${event.lecturer ? `<span class="event-lecturer">${event.lecturer}</span>` : ''}
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div>';
                });
            });
            html += '</div>';

            grid.innerHTML = html;
        }

        function calculateDuration(timeRange) {
            const [start, end] = timeRange.split(' - ');
            const [startHour] = start.split('.').map(Number);
            const [endHour] = end.split('.').map(Number);
            const duration = endHour - startHour;
            return duration * 60;
        }

        function openBookingModal(date, scheduleId) {
            const events = scheduleData[date];
            const event = events.find(e => e.schedule_id == scheduleId);
            
            if (!event || event.type !== 'available') return;

            selectedSchedule = {
                schedule_id: scheduleId,
                lecturer_sched_id: event.lecturer_sched_id,
                lecturer_id: event.lecturer_id,
                date: date,
                time: event.time,
                lecturer: event.lecturer
            };

            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            document.getElementById('modal-datetime').textContent = `${formattedDate}, ${event.time}`;
            document.getElementById('modal-lecturer').textContent = event.lecturer || 'Belum ditentukan';
            document.getElementById('booking-notes').value = '';
            document.getElementById('booking-mode').value = 'offline';
            document.getElementById('booking-location').value = '';
            toggleLocationInput();

            bookingModal.show();
        }

        function toggleLocationInput() {
            const mode = document.getElementById('booking-mode').value;
            const locationInput = document.getElementById('booking-location');
            
            if (mode === 'online') {
                locationInput.placeholder = 'Contoh: https://meet.google.com/abc-defg-hij';
            } else {
                locationInput.placeholder = 'Contoh: Ruang 301';
            }
        }

        async function confirmBooking() {
            const userSession = JSON.parse(localStorage.getItem('user_session'));
            const notes = document.getElementById('booking-notes').value;
            const mode = document.getElementById('booking-mode').value;
            const location = document.getElementById('booking-location').value;

            if (!location) {
                alert('Harap isi ruangan atau link meeting!');
                return;
            }

            const bookingData = {
                lecturer_sched_id: selectedSchedule.lecturer_sched_id,
                student_id: userSession.user_id,
                date: selectedSchedule.date,
                mode: mode,
                location: location,
                notes: notes
            };

            try {
                const response = await fetch('/api/schedules/book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Booking berhasil! Menunggu konfirmasi dosen.');
                    bookingModal.hide();
                    fetchCalendarData();
                } else {
                    alert(result.message || 'Booking gagal!');
                }
            } catch (error) {
                console.error('Error booking:', error);
                alert('Gagal terhubung ke server.');
            }
        }

        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            fetchCalendarData();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            fetchCalendarData();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchCalendarData();
        });
    </script>
</body>
</html>