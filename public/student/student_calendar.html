<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Kalender Bimbingan - Student</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <style>
      /* Custom Calendar Style agar match dengan tema */
      #calendar {
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        min-height: 600px;
      }
      .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 700;
        color: #333;
      }
      .fc-button-primary {
        background-color: #0d6efd !important;
        border: none !important;
      }
      .fc-day-today {
        background-color: #f0f7ff !important;
      }
      .fc-event {
        cursor: pointer;
        border-radius: 4px;
        border: none;
      }

      /* Filter Card */
      .card-filter {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        height: 100%;
      }

      /* Slot Button */
      .btn-slot {
        border: 1px solid #dee2e6;
        background: #fff;
        color: #333;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn-slot:hover,
      .btn-slot.active {
        background: #e7f1ff;
        border-color: #0d6efd;
        color: #0d6efd;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="fw-bold text-primary mb-1">Kalender Bimbingan</h2>
              <div class="d-flex align-items-center gap-3">
                <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3"><i class="fas fa-sign-out-alt"></i> Logout</button>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-lg-8">
                <div id="calendar"></div>
              </div>

              <div class="col-lg-4">
                <div class="card-filter">
                  <h5 class="fw-bold mb-3"><i class="fas fa-filter me-2 text-primary"></i>Filter Ketersediaan</h5>

                  <div class="mb-4">
                    <label class="small text-muted fw-bold mb-2">Cari Slot Waktu Untuk:</label>
                    <select id="supervisorFilter" class="form-select rounded-pill shadow-sm">
                      <option value="" disabled selected>Loading...</option>
                    </select>
                    <small class="text-muted fst-italic mt-2 d-block" style="font-size: 0.8rem"> *Pilih "Gabungan" untuk mencari waktu dimana kedua pembimbing kosong. </small>
                  </div>

                  <hr class="dashed-line my-4" />

                  <div id="slotResultContainer" style="display: none">
                    <h6 class="fw-bold mb-3 text-dark"><i class="far fa-clock me-2 text-warning"></i>Slot Tersedia: <br /><span id="selectedDateLabel" class="text-primary small"></span></h6>

                    <div id="slotsWrapper" class="d-grid gap-2" style="max-height: 300px; overflow-y: auto"></div>

                    <div class="mt-3">
                      <button id="btnProceedRequest" class="btn btn-primary-custom w-100 rounded-pill fw-bold" disabled onclick="proceedToRequest()">Ajukan di Jam Ini</button>
                    </div>
                  </div>

                  <div id="emptyStateContainer" class="text-center py-5 text-muted">
                    <i class="far fa-calendar-alt fa-3x mb-3 opacity-25"></i>
                    <p class="small">Klik tanggal di kalender untuk melihat jam yang tersedia.</p>
                  </div>
                </div>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
      let calendar;
      let selectedDateStr = "";
      let selectedSlot = "";
      let mySupervisors = []; // Cache data pembimbing

      document.addEventListener("DOMContentLoaded", async () => {
        // 1. Cek Sesi
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession || userSession.role !== "student") {
          window.location.href = "/login";
          return;
        }

        // 2. Inisialisasi FullCalendar
        initCalendar();

        // 3. Load Data Pembimbing (Untuk Filter)
        await loadSupervisors(userSession.user_id);

        // 4. Listener Filter Change
        document.getElementById("supervisorFilter").addEventListener("change", () => {
          // Jika user ganti filter, dan sudah ada tanggal terpilih, refresh slot
          if (selectedDateStr) fetchSlots(selectedDateStr);
        });
      });

      function initCalendar() {
        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            // [REVISI] Menghapus 'timeGridWeek', hanya menyisakan Month View
            right: "dayGridMonth",
          },
          locale: "id", // Bahasa Indonesia
          firstDay: 1, // Senin
          selectable: true, // Bisa diklik
          height: "auto",

          // Saat tanggal diklik
          dateClick: function (info) {
            // Highlight visual (hapus highlight lama)
            document.querySelectorAll(".fc-day").forEach((el) => (el.style.backgroundColor = ""));
            info.dayEl.style.backgroundColor = "#e7f1ff";

            selectedDateStr = info.dateStr;

            // Tampilkan tanggal di sidebar
            const dateObj = new Date(selectedDateStr);
            const options = { weekday: "long", day: "numeric", month: "long", year: "numeric" };
            document.getElementById("selectedDateLabel").innerText = dateObj.toLocaleDateString("id-ID", options);

            // Fetch Slot
            fetchSlots(selectedDateStr);
          },
        });
        calendar.render();
      }

      // --- LOGIC SUPERVISOR (FILTER) ---

      async function loadSupervisors(studentId) {
        const select = document.getElementById("supervisorFilter");

        // *SIMULASI FETCH DATA DARI JADWAL* // (Idealnya endpoint: /api/student/supervisors/:id)
        // Di real implementation, Anda fetch dari endpoint yang return [{id: 1, name: 'Dosen A'}, {id: 2, name: 'Dosen B'}]

        // Disini saya pakai logika simulasi data agar fitur Double TA terlihat
        // Asumsi: Kita dapat data ini dari backend
        const dummySupervisors = [
          { id: 2, name: "Pascal Alfadian" }, // P1
          { id: 3, name: "Vania Natali" }, // P2 (Misal)
        ];
        mySupervisors = dummySupervisors;

        // Render Options
        let html = "";

        // Opsi Per Dosen
        mySupervisors.forEach((s, index) => {
          html += `<option value="${s.id}">Bimbingan dgn: ${s.name}</option>`;
        });

        // LOGIC DOUBLE TA: Jika ada > 1 pembimbing, tambah opsi gabungan
        if (mySupervisors.length > 1) {
          const allIds = mySupervisors.map((s) => s.id).join(",");
          html += `<option value="${allIds}" class="fw-bold text-primary">â˜… Gabungan (Sidang/Joint)</option>`;
        }

        select.innerHTML = html;
      }

      // --- LOGIC SLOT FINDER ---

      async function fetchSlots(date) {
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const container = document.getElementById("slotsWrapper");
        const resultDiv = document.getElementById("slotResultContainer");
        const emptyDiv = document.getElementById("emptyStateContainer");
        const filterVal = document.getElementById("supervisorFilter").value;

        // UI Reset
        emptyDiv.style.display = "none";
        resultDiv.style.display = "block";
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small mt-2">Mencocokkan jadwal...</div></div>';
        document.getElementById("btnProceedRequest").disabled = true;

        if (!filterVal) {
          container.innerHTML = '<div class="text-center text-danger small">Pilih dosen terlebih dahulu.</div>';
          return;
        }

        try {
          // Panggil API (filterVal bisa "1" atau "1,2")
          const res = await fetch(`/api/schedules/available-slots?lecturerIds=${filterVal}&studentId=${userSession.user_id}&date=${date}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              html += `
                <button class="btn btn-slot w-100 mb-2 py-2" onclick="selectSlot(this, '${slot.value}')">
                    ${slot.value}
                </button>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="far fa-times-circle fa-2x text-muted mb-2"></i>
                    <p class="small text-muted mb-0">Tidak ada jadwal yang cocok di tanggal ini.</p>
                    <small class="text-muted" style="font-size:0.7rem">Coba tanggal lain atau ganti filter dosen.</small>
                </div>`;
          }
        } catch (e) {
          console.error(e);
          container.innerHTML = '<div class="text-center text-danger small">Gagal memuat slot.</div>';
        }
      }

      function selectSlot(btn, timeRange) {
        // Visual Active State
        document.querySelectorAll(".btn-slot").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        selectedSlot = timeRange;
        document.getElementById("btnProceedRequest").disabled = false;
      }

      function proceedToRequest() {
        if (!selectedDateStr || !selectedSlot) return;

        // Logic: Redirect ke halaman Request dengan query params agar form terisi otomatis
        // Atau buka modal request (jika kita mau reuse modal di halaman schedule)

        // Disini saya contohkan redirect ke halaman Schedule List dan otomatis memicu modal
        // Tapi lebih baik jika calendar ini jadi halaman mandiri.

        alert(`Mengarahkan ke form pengajuan untuk tanggal ${selectedDateStr} jam ${selectedSlot}...`);

        // Simpan data di sessionStorage sementara untuk diambil di halaman form
        sessionStorage.setItem(
          "prefill_request",
          JSON.stringify({
            lecturerIds: document.getElementById("supervisorFilter").value,
            date: selectedDateStr,
            time: selectedSlot,
          })
        );

        // Redirect ke halaman student schedule (tempat form berada)
        window.location.href = "/student/schedule";
      }
      function logout() {
        localStorage.clear();
        window.location.href = "/login";
      }
    </script>
  </body>
</html>
