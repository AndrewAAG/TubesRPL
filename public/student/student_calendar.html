<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalender Ketersediaan - Student</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <style>
      #calendar {
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        min-height: 600px;
      }
      .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 700;
        color: #333;
      }
      .fc-button-primary {
        background-color: #0d6efd !important;
        border: none !important;
      }
      .fc-day-today {
        background-color: #f0f7ff !important;
      }
      .fc-daygrid-day {
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .fc-daygrid-day:hover {
        background-color: #f8f9fa;
      }

      /* Filter Card */
      .card-filter {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        height: 100%;
      }

      /* Tampilan Slot Statis (Read Only) */
      .slot-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #495057;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        text-align: center;
        transition: all 0.2s;
      }
      .slot-item:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="fw-bold text-primary mb-1">Cek Ketersediaan Dosen</h2>
              
              <div class="d-flex align-items-center gap-3">
                 <div class="notification-circle" id="bell-icon">
                    <i class="fas fa-bell fa-lg text-secondary"></i>
                    <span class="badge-dot"></span>
                 </div>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-lg-8">
                <div id="calendar"></div>
              </div>

              <div class="col-lg-4">
                <div class="card-filter">
                  <h5 class="fw-bold mb-3"><i class="fas fa-filter me-2 text-primary"></i>Filter Dosen</h5>

                  <div class="mb-4">
                    <label class="small text-muted fw-bold mb-2">Lihat Jadwal Milik:</label>
                    <select id="supervisorFilter" class="form-select rounded-pill shadow-sm">
                      <option value="" disabled selected>Loading...</option>
                    </select>
                    <small class="text-muted fst-italic mt-2 d-block" style="font-size: 0.75rem">
                       *Pilih "Gabungan" untuk melihat irisan waktu kosong kedua dosen.
                    </small>
                  </div>

                  <hr class="dashed-line my-4" />

                  <div id="slotResultContainer" style="display: none">
                    <h6 class="fw-bold mb-3 text-dark">
                        <i class="far fa-clock me-2 text-warning"></i>
                        Waktu Tersedia: <br />
                        <span id="selectedDateLabel" class="text-primary small"></span>
                    </h6>

                    <div id="slotsWrapper" class="d-flex flex-column" style="max-height: 400px; overflow-y: auto">
                        </div>
                  </div>

                  <div id="emptyStateContainer" class="text-center py-5 text-muted">
                    <i class="far fa-calendar-alt fa-3x mb-3 opacity-25"></i>
                    <p class="small">Klik tanggal di kalender untuk melihat jam yang tersedia.</p>
                  </div>
                </div>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/notification.js"></script>
    <script>
      let calendar;
      let selectedDateStr = "";

      document.addEventListener("DOMContentLoaded", async () => {
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession || userSession.role !== "student") {
          window.location.href = "/login";
          return;
        }

        initCalendar();
        await loadSupervisors(userSession.user_id);

        // Jika filter ganti, refresh slot tanggal yang sedang dipilih
        document.getElementById("supervisorFilter").addEventListener("change", () => {
          if (selectedDateStr) fetchSlots(selectedDateStr);
        });
      });

      function initCalendar() {
        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "", 
          },
          locale: "id", 
          firstDay: 1, 
          selectable: true, 
          height: "auto",
          
          // Event Klik Tanggal
          dateClick: function (info) {
            // Visual Highlight
            document.querySelectorAll(".fc-daygrid-day").forEach((el) => (el.style.backgroundColor = ""));
            info.dayEl.style.backgroundColor = "#e7f1ff";

            selectedDateStr = info.dateStr;

            // Update Label
            const dateObj = new Date(selectedDateStr);
            const options = { weekday: "long", day: "numeric", month: "long", year: "numeric" };
            document.getElementById("selectedDateLabel").innerText = dateObj.toLocaleDateString("id-ID", options);

            // Fetch Slot
            fetchSlots(selectedDateStr);
          },
        });
        calendar.render();
      }

      async function loadSupervisors(studentId) {
        const select = document.getElementById("supervisorFilter");
        select.innerHTML = '<option value="" disabled selected>Memuat data...</option>';

        try {
          const res = await fetch(`/api/schedules/supervisors/${studentId}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = '<option value="" disabled selected>- Pilih Filter -</option>';
            
            // Opsi Individual
            result.data.forEach((s) => {
              html += `<option value="${s.id}">Jadwal: ${s.name}</option>`;
            });

            // Opsi Gabungan
            if (result.data.length > 1) {
              const allIds = result.data.map((s) => s.id).join(",");
              html += `<option value="${allIds}" class="fw-bold text-primary">Gabungan 2 Pembimbing</option>`;
            }
            select.innerHTML = html;
          } else {
            select.innerHTML = '<option value="" disabled selected>Tidak ada pembimbing.</option>';
          }
        } catch (e) {
          console.error(e);
          select.innerHTML = '<option value="">Error memuat data.</option>';
        }
      }

      async function fetchSlots(date) {
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const container = document.getElementById("slotsWrapper");
        const resultDiv = document.getElementById("slotResultContainer");
        const emptyDiv = document.getElementById("emptyStateContainer");
        const filterVal = document.getElementById("supervisorFilter").value;

        emptyDiv.style.display = "none";
        resultDiv.style.display = "block";
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small mt-2">Mengecek ketersediaan...</div></div>';

        if (!filterVal) {
          container.innerHTML = '<div class="text-center text-danger small p-3">Silakan pilih dosen di filter atas terlebih dahulu.</div>';
          return;
        }

        try {
          const res = await fetch(`/api/schedules/available-slots?lecturerIds=${filterVal}&studentId=${userSession.user_id}&date=${date}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              // Render sebagai DIV biasa (bukan button)
              html += `
                <div class="slot-item">
                    <i class="far fa-clock me-2 text-primary"></i> ${slot.value}
                </div>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="far fa-times-circle fa-2x text-muted mb-2"></i>
                    <p class="small text-muted mb-0">Tidak ada jadwal kosong.</p>
                </div>`;
          }
        } catch (e) {
          console.error(e);
          container.innerHTML = '<div class="text-center text-danger small">Gagal memuat data.</div>';
        }
      }
    </script>
  </body>
</html>