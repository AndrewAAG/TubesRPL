<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Evaluasi - Student</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../css/style.css" />
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-5">
              <div>
                <h2 class="fw-bold text-primary mb-1">Evaluasi Bimbingan</h2>
                <p class="text-muted small">Detail Hasil & Tugas</p>
              </div>
              <div class="d-flex align-items-center gap-3">
                  <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3 d-flex align-items-center gap-2"><i class="fas fa-sign-out-alt"></i> Logout</button>                <div class="notification-circle">
                  <i class="fas fa-bell fa-lg text-secondary"></i>
                  <span class="badge-dot">2</span>
                </div>
              </div>
            </div>

            <div class="card-blue-header mb-4">
              <div class="card-header-custom">Catatan Bimbingan</div>
              <div class="card-body-custom p-4 bg-white" style="min-height: 150px">
                <p class="text-secondary mb-0" id="notes-content">Loading catatan...</p>
              </div>
            </div>

            <div class="card-blue-header mb-4">
              <div class="card-header-custom">Tugas Dari Dosen</div>
              <div class="card-body-custom bg-white" id="tasks-container">
                <div class="p-4 text-center text-muted">Loading tugas...</div>
              </div>
            </div>

            <div class="d-flex justify-content-end">
              <a href="/student/evaluation" class="btn btn-primary-custom rounded-pill px-5 fw-bold shadow-sm"> Close </a>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/sidebar.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // 1. Ambil ID Appointment dari URL (?id=101)
        const urlParams = new URLSearchParams(window.location.search);
        const appId = urlParams.get("id");

        if (!appId) {
          alert("Data tidak ditemukan");
          window.location.href = "/student/evaluation";
          return;
        }

        fetchDetail(appId);
      });

      async function fetchDetail(appId) {
        try {
          const response = await fetch(`/api/evaluations/detail/${appId}`);
          const result = await response.json();

          if (result.success) {
            renderPage(result.data);
          } else {
            alert(result.message);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function renderPage(data) {
        // 1. Render Catatan
        const notesEl = document.getElementById("notes-content");
        notesEl.innerText = data.notes || "Tidak ada catatan khusus.";

        // 2. Render Tugas
        const taskContainer = document.getElementById("tasks-container");

        if (data.tasks.length === 0) {
          taskContainer.innerHTML = '<div class="p-4 text-center text-muted">Tidak ada tugas baru.</div>';
          return;
        }

        let html = "";
        data.tasks.forEach((task) => {
          // Tentukan selected option berdasarkan status saat ini
          const selPending = task.status === "pending" ? "selected" : "";
          const selProgress = task.status === "in_progress" ? "selected" : "";
          const selCompleted = task.status === "completed" ? "selected" : "";

          // Tentukan warna background dropdown biar cantik
          let bgClass = "bg-light";
          if (task.status === "completed") bgClass = "bg-success-subtle text-success";
          else if (task.status === "in_progress") bgClass = "bg-warning-subtle text-warning";

          html += `
        <div class="list-item-row d-flex justify-content-between align-items-center">
            <div class="fw-bold text-dark" style="font-size: 1rem;">
                ${task.description}
            </div>
            
            <div>
                <select class="form-select form-select-sm fw-bold border-0 shadow-sm ${bgClass}" 
                        style="border-radius: 20px; width: 140px; cursor: pointer;"
                        onchange="updateStatus(${task.task_id}, this)">
                    <option value="pending" ${selPending}>Pending</option>
                    <option value="in_progress" ${selProgress}>In Progress</option>
                    <option value="completed" ${selCompleted}>Completed</option>
                </select>
            </div>
        </div>
        `;
        });

        taskContainer.innerHTML = html;
      }

      // Fungsi Update Status (Dipanggil saat dropdown berubah)
      async function updateStatus(taskId, selectElement) {
        const newStatus = selectElement.value;

        // Update visual warna dropdown langsung (UX instant)
        selectElement.className = "form-select form-select-sm fw-bold border-0 shadow-sm"; // Reset
        if (newStatus === "completed") selectElement.classList.add("bg-success-subtle", "text-success");
        else if (newStatus === "in_progress") selectElement.classList.add("bg-warning-subtle", "text-warning");
        else selectElement.classList.add("bg-light");

        try {
          const response = await fetch(`/api/evaluations/task/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus }),
          });

          const result = await response.json();
          if (!result.success) {
            alert("Gagal update status");
          }
        } catch (error) {
          console.error("Update error:", error);
          alert("Terjadi kesalahan koneksi");
        }
      }
      function logout() {
      localStorage.clear();
      window.location.href = "/login";
    }
    </script>
  </body>
</html>
