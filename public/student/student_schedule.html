<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jadwal Bimbingan - Student</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-5">
              <div>
                <h2 class="fw-bold text-primary mb-1">Jadwal Bimbingan</h2>
                <p class="text-muted small">Hari ini <span id="currentDateDisplay" class="text-dark fw-bold">Memuat...</span></p>
              </div>

              <div class="d-flex align-items-center gap-3">
                <div class="notification-circle" id="bell-icon" style="cursor: pointer">
                  <i class="fas fa-bell fa-lg text-secondary"></i>
                  <span class="badge-dot">2</span>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-end mb-4">
              <button class="btn btn-primary-custom rounded-pill px-4 shadow-sm d-flex align-items-center" onclick="openRequestModal()"><i class="fas fa-plus me-2"></i> Ajukan Bimbingan</button>
            </div>

            <div id="schedule-container"></div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="notification-component-placeholder"></div>

    <div class="modal fade" id="requestModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 15px">
          <div class="modal-header border-0 pb-0 pt-4 px-4">
            <h5 class="fw-bold">Pengajuan Bimbingan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body p-4">
            <form id="requestForm">
              <div class="mb-3">
                <label class="fw-bold small mb-1">Bimbingan Dengan:</label>
                <select id="reqSupervisor" class="form-select rounded-pill" required>
                  <option value="">Loading...</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="fw-bold small mb-1">Tanggal</label>
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0 rounded-start-pill"><i class="far fa-calendar"></i></span>
                  <input type="date" id="reqDate" class="form-control border-start-0 rounded-end-pill" required />
                </div>
              </div>

              <div class="mb-3">
                <label class="fw-bold small mb-1">Waktu</label>
                <div id="slotsContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background: #fff">
                  <small class="text-muted d-block text-center py-3"> Pilih pembimbing & tanggal untuk melihat jam tersedia. </small>
                </div>
              </div>

              <div class="mb-3">
                <label class="fw-bold small mb-2 d-block">Mode Bimbingan</label>
                <div class="d-flex gap-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="reqMode" id="modeOnline" value="online" checked onchange="toggleLocation()" />
                    <label class="form-check-label" for="modeOnline">Online</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="reqMode" id="modeOnsite" value="onsite" onchange="toggleLocation()" />
                    <label class="form-check-label" for="modeOnsite">On Site</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="fw-bold small mb-1" id="labelLocation">Link Meeting / Lokasi</label>
                <input type="text" id="reqLocation" class="form-control rounded-3" required />
              </div>

              <div class="mb-4">
                <label class="fw-bold small mb-1">Catatan untuk Dosen</label>
                <textarea id="reqNotes" class="form-control rounded-3" rows="3"></textarea>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-primary-custom rounded-pill py-2 fw-bold">Ajukan Bimbingan</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="rescheduleModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 15px">
          <div class="modal-header border-0 pb-0 pt-4 px-4">
            <h5 class="fw-bold text-warning">Reschedule Bimbingan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4">
            <form id="rescheduleForm">
              <input type="hidden" id="reschAppId" /> <input type="hidden" id="reschLecturerIds" />
              <div class="mb-3">
                <label class="fw-bold small mb-1">Tanggal Baru</label>
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0 rounded-start-pill"><i class="far fa-calendar"></i></span>
                  <input type="date" id="reschDate" class="form-control border-start-0 rounded-end-pill" required />
                </div>
              </div>

              <div class="mb-3">
                <label class="fw-bold small mb-1">Waktu Tersedia</label>
                <div id="reschSlotsContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background: #fff">
                  <small class="text-muted d-block text-center py-3">Pilih tanggal baru.</small>
                </div>
              </div>

              <div class="mb-4">
                <label class="fw-bold small mb-1">Alasan Perubahan</label>
                <textarea id="reschReason" class="form-control rounded-3" rows="2" placeholder="Cth: Sakit, ada urusan keluarga..." required></textarea>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-warning rounded-pill py-2 fw-bold text-white">Ajukan Perubahan</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/notification.js"></script>

    <script>
      // [REVISI] Script Tanggal Dinamis
      function setDynamicDate() {
        const dateOptions = { weekday: "long", day: "numeric", month: "long", year: "numeric" };
        const today = new Date().toLocaleDateString("id-ID", dateOptions);
        document.getElementById("currentDateDisplay").innerText = today;
      }

      async function fetchSchedules() {
        const container = document.getElementById("schedule-container");
        const userSession = JSON.parse(localStorage.getItem("user_session"));

        if (!userSession || !userSession.user_id) {
          alert("Sesi habis, silakan login kembali.");
          window.location.href = "login.html";
          return;
        }

        container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-2 text-muted small">Memuat jadwal Anda...</div>
        </div>`;

        try {
          const response = await fetch(`/api/schedules/student/${userSession.user_id}`);
          const result = await response.json();

          if (result.success) {
            renderSchedules(result.data);
          } else {
            container.innerHTML = `<div class="text-center text-danger py-5">${result.message}</div>`;
          }
        } catch (error) {
          console.error("Error fetching schedules:", error);
          container.innerHTML = `<div class="text-center text-danger py-5">Gagal terhubung ke server.</div>`;
        }
      }

      function renderSchedules(schedules) {
        const container = document.getElementById("schedule-container");

        const activeSchedules = schedules.filter((item) => {
          return item.status !== 'completed';
        });

        if (!activeSchedules || activeSchedules.length === 0) {
          container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="far fa-calendar-check fa-3x mb-3"></i>
                <p>Tidak ada jadwal bimbingan aktif.</p>
            </div>`;
          return;
        }

        let htmlContent = "";

        // Looping data yang sudah difilter (activeSchedules)
        activeSchedules.forEach((item) => {
          let linkDisplay = "";
          const roomDisplay = item.type === "On Site" && item.location ? item.location : "--";

          if (item.type === "Online") {
            linkDisplay = item.link
              ? `<a href="${item.link}" target="_blank" class="text-decoration-none text-primary fw-bold text-truncate d-block" style="max-width: 90%;">${item.link}</a>`
              : '<span class="text-muted small">Link belum tersedia</span>';
          } else {
            linkDisplay = '<span class="text-muted">--</span>';
          }

          const btnClass = item.canReschedule ? "btn-primary-custom" : "btn-light text-muted border-0";
          // Pastikan properti canReschedule dikirim dari backend, atau atur logic di sini
          const btnAttr = item.canReschedule ? `onclick="openReschModal(${item.id}, '${item.lecturer_ids_str}')"` : "disabled";

          htmlContent += `
        <div class="card-schedule">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <span class="badge-pill-custom">${item.type}</span>
                <span class="${item.statusClass} px-3 py-1 rounded-pill small fw-bold text-capitalize">${item.status}</span>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="label-text">Tanggal dan Waktu</div>
                    <div class="value-text fs-5 mb-1">${item.date}</div>
                    <div class="value-text small text-muted">
                        <i class="far fa-clock me-1"></i> ${item.time}
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="label-text">Dosen Pembimbing</div>
                    <div class="value-text">
                        ${item.lecturers.map((name) => `<div>${name}</div>`).join("")}
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="label-text">Ruangan</div>
                    <div class="value-text">${roomDisplay}</div>
                </div>
            </div>

            <div class="dashed-line"></div>

            <div class="row align-items-center mt-3">
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="label-text">Tautan</div>
                    <div class="value-text">${linkDisplay}</div>
                </div>

                <div class="col-md-5 mb-3 mb-md-0">
                    <div class="label-text">Catatan:</div>
                    <span class="text-muted small">${item.notes || "-"}</span>
                </div>

                <div class="col-md-3 text-md-end">
                    <button class="btn btn-sm ${btnClass} rounded-pill px-4 fw-bold shadow-sm" ${btnAttr}>
                        Reschedule
                    </button>
                </div>
            </div>
        </div>
        `;
        });

        container.innerHTML = htmlContent;
      }

      document.addEventListener("DOMContentLoaded", () => {
        setDynamicDate(); // Set tanggal saat load
        fetchSchedules();
      });

      async function openRequestModal() {
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession) return;

        // 1. Reset Form
        document.getElementById("requestForm").reset();
        document.getElementById("slotsContainer").innerHTML = '<small class="text-muted d-block text-center py-3">Pilih tanggal.</small>';

        const today = new Date().toISOString().split('T')[0];
        document.getElementById("reqDate").min = today;

        // 2. Load Supervisor
        await loadSupervisorsForModal(userSession.user_id);

        // 3. Tampilkan Modal
        new bootstrap.Modal(document.getElementById("requestModal")).show();
      }

      async function loadSupervisorsForModal(studentId) {
        const select = document.getElementById("reqSupervisor");
        select.innerHTML = '<option value="">Memuat...</option>';

        try {
          const res = await fetch(`/api/schedules/supervisors/${studentId}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = '<option value="" disabled selected>- Pilih Target -</option>';

            // Opsi Individual
            result.data.forEach((s) => {
              html += `<option value="${s.id}">Bimbingan dgn: ${s.name}</option>`;
            });

            // Opsi Gabungan (Jika Double TA)
            if (result.data.length > 1) {
              const allIds = result.data.map((s) => s.id).join(",");
              html += `<option value="${allIds}" class="fw-bold text-primary">Gabungan 2 Pembimbing</option>`;
            }
            select.innerHTML = html;
          } else {
            select.innerHTML = '<option value="">Belum ada pembimbing</option>';
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Event Listener: Cari Slot saat Tanggal/Dosen berubah
      const fetchSlotListener = async () => {
        const lecturerIds = document.getElementById("reqSupervisor").value;
        const date = document.getElementById("reqDate").value;
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const container = document.getElementById("slotsContainer");

        if (!lecturerIds || !date) return;

        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

        try {
          const res = await fetch(`/api/schedules/available-slots?lecturerIds=${lecturerIds}&studentId=${userSession.user_id}&date=${date}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              html += `
                <div class="form-check border-bottom py-2">
                    <input class="form-check-input" type="radio" name="reqSlot" value="${slot.value}" id="slot_${slot.start}" required>
                    <label class="form-check-label w-100" for="slot_${slot.start}" style="cursor:pointer">
                        ${slot.value}
                    </label>
                </div>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `<div class="text-center text-danger small py-2">
                <i class="far fa-times-circle mb-1"></i><br>
                Tidak ada jadwal yang cocok di tanggal ini.<br>
                (Cek jadwal kuliah Anda atau jadwal dosen)
            </div>`;
          }
        } catch (e) {
          container.innerHTML = "Error koneksi.";
        }
      };

      document.getElementById("reqDate").addEventListener("change", fetchSlotListener);
      document.getElementById("reqSupervisor").addEventListener("change", fetchSlotListener);

      // Helper UI: Lokasi vs Link
      function toggleLocation() {
        const isOnline = document.getElementById("modeOnline").checked;
        const input = document.getElementById("reqLocation");
        const label = document.getElementById("labelLocation");

        if (isOnline) {
          label.innerText = "Link Meeting";
          input.placeholder = "https://meet.google.com/...";
        } else {
          label.innerText = "Ruangan / Lokasi";
          input.placeholder = "Contoh: Ruang 9.2.1";
        }
      }

      // Submit Request
      document.getElementById("requestForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const lecturerIds = document.getElementById("reqSupervisor").value;
        const slotEl = document.querySelector('input[name="reqSlot"]:checked');

        if (!slotEl) {
          alert("Silakan pilih slot waktu.");
          return;
        }

        const body = {
          studentId: userSession.user_id,
          lecturerIds: lecturerIds, // "1" atau "1,2"
          date: document.getElementById("reqDate").value,
          timeRange: slotEl.value,
          mode: document.querySelector('input[name="reqMode"]:checked').value,
          location: document.getElementById("reqLocation").value,
          notes: document.getElementById("reqNotes").value,
        };

        const btn = e.target.querySelector('button[type="submit"]');
        const oriText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Mengirim...";

        try {
          const res = await fetch("/api/schedules/request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const result = await res.json();

          if (result.success) {
            alert("Pengajuan berhasil dikirim!");
            bootstrap.Modal.getInstance(document.getElementById("requestModal")).hide();
            fetchSchedules(); // Refresh list jadwal utama
          } else {
            alert(result.message);
          }
        } catch (err) {
          alert("Gagal mengirim data.");
        } finally {
          btn.disabled = false;
          btn.innerText = oriText;
        }
      });

      // --- LOGIC RESCHEDULE ---

      // 1. Buka Modal
      // (Dipanggil dari tombol di renderSchedules: onclick="openReschModal(12, '1,2')")
      function openReschModal(appId, lecturerIdsStr) {
        document.getElementById("rescheduleForm").reset();
        document.getElementById("reschSlotsContainer").innerHTML = '<small class="text-muted d-block text-center py-3">Pilih tanggal baru.</small>';

        // Set Hidden Values
        document.getElementById("reschAppId").value = appId;
        document.getElementById("reschLecturerIds").value = lecturerIdsStr; // String "1" atau "1,2"

        const today = new Date().toISOString().split('T')[0];
        document.getElementById("reschDate").min = today;

        new bootstrap.Modal(document.getElementById("rescheduleModal")).show();
      }

      // 2. Cari Slot Baru (Saat tanggal diganti)
      document.getElementById("reschDate").addEventListener("change", async function () {
        const date = this.value;
        const lecturerIds = document.getElementById("reschLecturerIds").value; // Ambil dari hidden input
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        const container = document.getElementById("reschSlotsContainer");

        if (!date) return;

        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-warning"></div></div>';

        try {
          // Reuse API Available Slots yang sudah canggih (Joint/Individual)
          const res = await fetch(`/api/schedules/available-slots?lecturerIds=${lecturerIds}&studentId=${userSession.user_id}&date=${date}`);
          const result = await res.json();

          if (result.success && result.data.length > 0) {
            let html = "";
            result.data.forEach((slot) => {
              html += `
                <div class="form-check border-bottom py-2">
                    <input class="form-check-input" type="radio" name="reschSlot" value="${slot.value}" id="rs_${slot.start}" required>
                    <label class="form-check-label w-100" for="rs_${slot.start}" style="cursor:pointer">
                        ${slot.value}
                    </label>
                </div>`;
            });
            container.innerHTML = html;
          } else {
            container.innerHTML = `<div class="text-center text-danger small py-2">Tidak ada slot kosong di tanggal ini.</div>`;
          }
        } catch (e) {
          container.innerHTML = "Error koneksi.";
        }
      });

      // 3. Submit Reschedule
      document.getElementById("rescheduleForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const appId = document.getElementById("reschAppId").value;
        const date = document.getElementById("reschDate").value;
        const slotEl = document.querySelector('input[name="reschSlot"]:checked');
        const reason = document.getElementById("reschReason").value;
        const userSession = JSON.parse(localStorage.getItem("user_session"));

        if (!slotEl) {
          alert("Pilih waktu baru.");
          return;
        }

        const btn = e.target.querySelector('button[type="submit"]');
        const oriText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Memproses...";

        try {
          const res = await fetch(`/api/schedules/${appId}/reschedule`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              date: date,
              timeRange: slotEl.value,
              reason: reason,
              userId: userSession.user_id,
              triggerBy: "student",
            }),
          });
          const result = await res.json();

          if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById("rescheduleModal")).hide();
            fetchSchedules(); // Refresh tabel utama
          } else {
            alert(result.message);
          }
        } catch (err) {
          alert("Error koneksi.");
        } finally {
          btn.disabled = false;
          btn.innerText = oriText;
        }
      });
    </script>
  </body>
</html>
