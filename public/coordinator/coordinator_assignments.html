<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Penetapan Bimbingan - Koordinator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      /* Table Styling */
      .table-custom thead th {
        background-color: #3b82f6; /* Header Biru sesuai screenshot */
        color: white;
        font-weight: 600;
        border: none;
        padding: 15px;
        text-align: center;
      }
      /* Radius untuk sudut kiri dan kanan header tabel */
      .table-custom thead th:first-child {
        border-top-left-radius: 15px;
      }
      .table-custom thead th:last-child {
        border-top-right-radius: 15px;
      }

      .table-custom tbody td {
        vertical-align: middle;
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.95rem;
      }

      .table-custom tbody tr:last-child td {
        border-bottom: none; /* Hilangkan border baris terakhir */
      }

      /* Kolom spesifik */
      .col-center {
        text-align: center;
      }
      .btn-edit-icon {
        color: #000;
        background: #fff;
        border: 1px solid #000;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.8rem;
        transition: 0.2s;
      }
      .btn-edit-icon:hover {
        background: #000;
        color: #fff;
      }

      /* Modal Styling */
      .modal-custom-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-5">
              <div>
                <h2 class="fw-bold text-primary mb-2">Penetapan Bimbingan</h2>

                <div class="d-inline-flex align-items-center px-3 py-1 rounded-pill bg-white border shadow-sm">
                  <span class="text-muted small me-2">Semester Aktif:</span>
                  <span class="fw-bold text-primary" id="activeSemesterLabel">Memuat...</span>
                </div>
              </div>

              <div class="d-flex align-items-center gap-3">
                <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3 d-flex align-items-center gap-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
                <div class="notification-circle">
                  <i class="fas fa-bell fa-lg text-secondary"></i>
                </div>
              </div>
            </div>

            <div class="card-standard p-0 border-0 shadow-sm" style="border-radius: 15px; overflow: hidden">
              <div class="table-responsive">
                <table class="table table-custom mb-0">
                  <thead>
                    <tr>
                      <th width="5%">No.</th>
                      <th width="15%">NPM</th>
                      <th width="25%">Nama</th>
                      <th width="40%">Dosen Pembimbing</th>
                      <th width="10%">Jalur</th>
                      <th width="5%"></th>
                    </tr>
                  </thead>
                  <tbody id="assignment-table-body"></tbody>
                </table>
              </div>
            </div>

            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="assignModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 15px">
          <div class="modal-body p-4">
            <h5 class="fw-bold mb-3">Tetapkan Dosen Pembimbing</h5>

            <div class="modal-custom-header d-flex align-items-center gap-3">
              <div class="bg-dark rounded-circle text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <h6 class="fw-bold mb-0 text-dark" id="modalStudentName">-</h6>
                <small class="text-muted" id="modalStudentNpm">-</small>
              </div>
            </div>

            <form id="assignForm">
              <input type="hidden" id="modalThesisId" />

              <div class="mb-3 row align-items-center">
                <label class="col-sm-5 col-form-label text-dark fw-medium">Dosen Pembimbing 1</label>
                <div class="col-sm-7">
                  <select id="p1Select" class="form-select border-dark" style="border-radius: 8px">
                    <option value="">- Pilih Dosen -</option>
                  </select>
                </div>
              </div>

              <div class="mb-4 row align-items-center">
                <label class="col-sm-5 col-form-label text-dark fw-medium">Dosen Pembimbing 2</label>
                <div class="col-sm-7">
                  <select id="p2Select" class="form-select border-dark" style="border-radius: 8px">
                    <option value="">- Kosongkan jika tidak ada -</option>
                  </select>
                </div>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-primary-custom rounded-pill fw-bold py-2">Tetapkan</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
      // public/js/coordinator_assignments.js

      let allStudents = [];
      let allLecturers = [];

      document.addEventListener("DOMContentLoaded", () => {
        // 1. Cek Sesi
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession || userSession.role !== "coordinator") {
          window.location.href = "/login";
          return;
        }

        fetchAssignments();

        // Form Submit
        document.getElementById("assignForm").addEventListener("submit", handleAssignSubmit);
      });

      async function fetchAssignments() {
        const tbody = document.getElementById("assignment-table-body");
        const semLabel = document.getElementById("activeSemesterLabel"); // Ambil elemen label

        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

        try {
          const res = await fetch("/api/coordinator/assignments");
          const result = await res.json();

          if (result.success) {
            allStudents = result.data.students;
            allLecturers = result.data.lecturers;

            // 1. UPDATE LABEL SEMESTER
            semLabel.innerText = result.data.active_semester || "Tidak Ada";

            // 2. Populate Dropdown & Render Table
            populateLecturerDropdowns(allLecturers);
            renderTable(allStudents);
          } else {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-5">${result.message}</td></tr>`;
            semLabel.innerText = "-";
          }
        } catch (e) {
          console.error(e);
        }
      }

      function populateLecturerDropdowns(lecturers) {
        const p1 = document.getElementById("p1Select");
        const p2 = document.getElementById("p2Select");

        let html = '<option value="">- Pilih Dosen -</option>';
        lecturers.forEach((lec) => {
          html += `<option value="${lec.user_id}">${lec.name}</option>`;
        });

        p1.innerHTML = html;
        p2.innerHTML = '<option value="">- Tidak Ada -</option>' + html; // P2 boleh kosong
      }

      function renderTable(students) {
        const tbody = document.getElementById("assignment-table-body");

        if (students.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">Tidak ada mahasiswa TA di semester aktif.</td></tr>';
          return;
        }

        let html = "";
        students.forEach((s) => {
          // Tampilkan tombol edit (ikon pensil kotak) sesuai screenshot
          html += `
        <tr>
            <td class="col-center fw-bold">${s.no}</td>
            <td class="col-center">${s.npm}</td>
            <td class="fw-bold text-dark">${s.name}</td>
            <td>${s.lecturer_display || '<span class="text-muted fst-italic">Belum ditetapkan</span>'}</td>
            <td class="col-center fw-bold">${s.stage}</td>
            <td class="col-center">
                <button class="btn-edit-icon" onclick="openAssignModal(${s.thesis_id})">
                    <i class="fas fa-pen"></i>
                </button>
            </td>
        </tr>
        `;
        });
        tbody.innerHTML = html;
      }

      // --- MODAL LOGIC ---

      function openAssignModal(thesisId) {
        const student = allStudents.find((s) => s.thesis_id === thesisId);
        if (!student) return;

        // Isi Info Mahasiswa
        document.getElementById("modalStudentName").innerText = student.name;
        document.getElementById("modalStudentNpm").innerText = student.npm;
        document.getElementById("modalThesisId").value = thesisId;

        // Set Selected Dosen
        document.getElementById("p1Select").value = student.p1_id || "";
        document.getElementById("p2Select").value = student.p2_id || "";

        // Buka Modal
        new bootstrap.Modal(document.getElementById("assignModal")).show();
      }

      async function handleAssignSubmit(e) {
        e.preventDefault();

        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = "Menyimpan...";
        btn.disabled = true;

        const body = {
          thesisId: document.getElementById("modalThesisId").value,
          p1Id: document.getElementById("p1Select").value,
          p2Id: document.getElementById("p2Select").value,
        };

        try {
          const res = await fetch("/api/coordinator/assignments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const result = await res.json();

          if (result.success) {
            // Tutup modal & refresh
            const modalEl = document.getElementById("assignModal");
            bootstrap.Modal.getInstance(modalEl).hide();
            fetchAssignments();
          } else {
            alert(result.message);
          }
        } catch (e) {
          alert("Terjadi kesalahan koneksi.");
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      function logout() {
        localStorage.clear();
        window.location.href = "/login";
      }
    </script>
  </body>
</html>
