<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Import Jadwal Dosen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .upload-area {
        border: 2px dashed #dce1e9;
        border-radius: 20px;
        background-color: #fff;
        padding: 60px 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
      }
      .upload-area:hover,
      .upload-area.dragover {
        background-color: #f8faff;
        border-color: #0d6efd;
      }

      .input-transparent {
        background: transparent;
        border: none;
        width: 100%;
        font-weight: 500;
      }
      .input-transparent:focus {
        background: #fff;
        outline: 2px solid #80bdff;
        border-radius: 4px;
      }
      .select-transparent {
        background: transparent;
        border: none;
        width: 100%;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-md-3 col-lg-2 p-0 h-100 sidebar-scrollable" id="sidebar-wrapper"></div>

        <div class="col-md-9 col-lg-10 h-100 p-0 position-relative bg-light">
          <div class="main-content-scrollable">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="fw-bold text-primary mb-1">Import Jadwal Dosen</h2>
              <div class="d-flex align-items-center gap-3">
                <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3"><i class="fas fa-sign-out-alt"></i> Logout</button>
              </div>
            </div>

            <div class="alert alert-info border-0 shadow-sm mb-4"><i class="fas fa-info-circle me-2"></i> Format CSV: <b>Email Dosen, Hari, Jam Mulai, Jam Selesai, Keterangan</b></div>

            <div id="section-upload">
              <div class="mb-3 text-end">
                <button class="btn btn-light bg-white shadow-sm rounded-pill px-4 text-primary fw-bold" onclick="showTableMode()"><i class="fas fa-edit me-2"></i> Input Manual</button>
              </div>
              <div class="upload-area shadow-sm" id="drop-zone">
                <i class="fas fa-file-csv fa-4x text-primary mb-3"></i>
                <h5 class="fw-bold text-dark">Drag & Drop File CSV di sini</h5>
                <p class="text-muted small mb-4">Pastikan email dosen sesuai dengan data akun.</p>

                <input type="file" id="fileInput" accept=".csv" hidden />

                <button id="btnSelectFile" class="btn btn-primary-custom rounded-pill px-5 fw-bold" type="button">Pilih File</button>
              </div>
            </div>

            <div id="section-table" style="display: none">
              <div class="card-standard p-4 border-0 shadow-sm">
                <div class="table-responsive rounded-3 border mb-3">
                  <table class="table table-hover mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th width="30%">Dosen</th>
                        <th width="15%">Hari</th>
                        <th width="15%">Mulai</th>
                        <th width="15%">Selesai</th>
                        <th width="20%">Keterangan</th>
                        <th width="5%"></th>
                      </tr>
                    </thead>
                    <tbody id="scheduleTableBody"></tbody>
                  </table>
                </div>
                <button class="btn btn-light border shadow-sm rounded-pill px-4 fw-bold mb-4" onclick="addEmptyRow()"><i class="fas fa-plus me-2"></i> Tambah Baris</button>
                <div class="d-flex gap-3 justify-content-center">
                  <button class="btn btn-primary-custom rounded-pill px-5 fw-bold" onclick="saveSchedules()">Simpan</button>
                  <button class="btn btn-danger rounded-pill px-5 fw-bold" onclick="location.reload()">Batal</button>
                </div>
              </div>
            </div>
            <div style="height: 50px"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
      // public/js/coordinator_import.js

      let lecturerList = []; // Cache data dosen

      document.addEventListener("DOMContentLoaded", async () => {
        // 1. Cek Sesi
        const userSession = JSON.parse(localStorage.getItem("user_session"));
        if (!userSession || userSession.role !== "coordinator") {
          window.location.href = "/login";
          return;
        }

        // 2. Load Data Dosen Dulu
        await fetchLecturerList();

        // 3. Setup Upload Listener
        setupUpload();
      });

      async function fetchLecturerList() {
        try {
          const res = await fetch("/api/coordinator/lecturers-list");
          const result = await res.json();

          if (result.success) {
            lecturerList = result.data;
            console.log("✅ Data Dosen Terload:", lecturerList.length, "orang");
            // Debug: Cek 3 data pertama
            if (lecturerList.length > 0) {
              console.log("Contoh data DB:", lecturerList[0].email, lecturerList[0].name);
            }
          } else {
            console.error("Gagal load dosen:", result.message);
          }
        } catch (e) {
          console.error("Error koneksi fetch dosen", e);
        }
      }

      // --- TABLE LOGIC ---

      function showTableMode() {
        document.getElementById("section-upload").style.display = "none";
        document.getElementById("section-table").style.display = "block";

        if (document.getElementById("scheduleTableBody").children.length === 0) {
          addEmptyRow();
        }
      }

      function cancelEdit() {
        if (confirm("Batalkan perubahan? Data akan direset.")) location.reload();
      }

      function addEmptyRow() {
        addRow({});
      }

      function cleanEmail(str) {
        if (!str) return "";
        return str
          .toString()
          .toLowerCase()
          .replace(/[^a-z0-9@.]/g, "");
      }

      function addRow(data = {}) {
        const tbody = document.getElementById("scheduleTableBody");
        const tr = document.createElement("tr");

        // 1. Bersihkan Email Input (CSV)
        const rawInput = data.email ? data.email.toString() : "";
        const inputEmail = cleanEmail(rawInput);

        let options = '<option value="">- Pilih Dosen -</option>';
        let foundMatch = false;

        // 2. Loop & Bandingkan
        if (Array.isArray(lecturerList)) {
          lecturerList.forEach((l) => {
            const rawDb = l.email ? l.email.toString() : "";
            const dbEmail = cleanEmail(rawDb);

            // Bandingkan versi bersih
            const isSel = inputEmail && dbEmail === inputEmail;

            if (isSel) {
              foundMatch = true;
            } else if (inputEmail.includes("pascal") && dbEmail.includes("pascal")) {
              // DEBUG KHUSUS: Jika mengandung nama 'pascal' tapi tidak match, print kenapa
              console.log(`⚠️ MISMATCH DETECTED!`);
              console.log(`CSV: "${inputEmail}" (Len: ${inputEmail.length})`);
              console.log(`DB : "${dbEmail}" (Len: ${dbEmail.length})`);
              console.log(`Raw CSV: "${rawInput}" | Raw DB: "${rawDb}"`);
            }

            options += `<option value="${l.email}" ${isSel ? "selected" : ""}>${l.name}</option>`;
          });
        }

        // Visual Feedback di Console
        if (inputEmail && !foundMatch) {
          console.warn(`❌ Gagal mencocokkan: ${inputEmail}`);
          console.log(
            "Daftar email di DB:",
            lecturerList.map((l) => cleanEmail(l.email))
          );
        }

        // Render HTML
        // Jika tidak match, border jadi MERAH dan background merah muda
        const styleError = "border: 2px solid red !important; background-color: #ffe6e6;";

        tr.innerHTML = `
        <td>
            <select class="form-select select-transparent border rounded" style="${foundMatch ? "" : styleError}">
                ${options}
            </select>
            ${!foundMatch && inputEmail ? `<div style="font-size:10px; color:red;">CSV: ${data.email}</div>` : ""}
        </td>
        <td>
            <select class="form-select select-transparent">
                <option ${data.day === "Senin" ? "selected" : ""}>Senin</option>
                <option ${data.day === "Selasa" ? "selected" : ""}>Selasa</option>
                <option ${data.day === "Rabu" ? "selected" : ""}>Rabu</option>
                <option ${data.day === "Kamis" ? "selected" : ""}>Kamis</option>
                <option ${data.day === "Jumat" ? "selected" : ""}>Jumat</option>
            </select>
        </td>
        <td><input type="time" class="input-transparent text-center" value="${data.start || "08:00"}"></td>
        <td><input type="time" class="input-transparent text-center" value="${data.end || "10:00"}"></td>
        <td><input type="text" class="input-transparent" value="${data.desc || "Mengajar"}" placeholder="Ket."></td>
        <td><button class="btn btn-sm text-danger" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
    `;
        tbody.appendChild(tr);
      }

      // --- CSV PARSER LOGIC ---

      function setupUpload() {
        const dropZone = document.getElementById("drop-zone");
        const fileInput = document.getElementById("fileInput");
        const btnSelect = document.getElementById("btnSelectFile");

        if (btnSelect) {
          btnSelect.addEventListener("click", (e) => {
            e.stopPropagation();
            fileInput.click();
          });
        }

        if (dropZone) {
          dropZone.addEventListener("click", (e) => {
            if (e.target === btnSelect) return;
            fileInput.click();
          });

          dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("dragover");
          });
          dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
          dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("dragover");
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
          });
        }

        if (fileInput) {
          fileInput.addEventListener("change", () => {
            if (fileInput.files.length) {
              handleFile(fileInput.files[0]);
              fileInput.value = "";
            }
          });
        }
      }

      function handleFile(file) {
        if (!file.name.toLowerCase().endsWith(".csv")) {
          alert("Format harus .csv");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => parseCSV(e.target.result);
        reader.onerror = () => alert("Gagal membaca file.");
        reader.readAsText(file); // Default UTF-8
      }

      function parseCSV(text) {
        // 1. HAPUS BOM (Byte Order Mark) jika ada di awal file
        // Ini penyebab utama baris pertama sering gagal match
        let cleanText = text.replace(/^\uFEFF/, "");

        const lines = cleanText.split(/\r\n|\n/);
        const firstLine = lines[0] || "";

        // Auto-detect delimiter
        const delimiter = firstLine.indexOf(";") !== -1 ? ";" : ",";
        console.log("Delimiter:", delimiter);

        const parsedData = [];
        let startIdx = firstLine.toLowerCase().includes("email") ? 1 : 0;

        for (let i = startIdx; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const cols = line.split(delimiter);

          if (cols.length >= 4) {
            const clean = (str) => (str ? str.replace(/^"|"$/g, "").trim() : "");

            parsedData.push({
              email: clean(cols[0]),
              day: clean(cols[1]),
              start: clean(cols[2]),
              end: clean(cols[3]),
              desc: cols[4] ? clean(cols[4]) : "",
            });
          }
        }

        if (parsedData.length > 0) {
          document.getElementById("scheduleTableBody").innerHTML = "";
          parsedData.forEach((d) => addRow(d));
          showTableMode();
        } else {
          alert("Gagal membaca data CSV. Pastikan format benar.");
        }
      }

      // --- SAVE ---

      async function saveSchedules() {
        const rows = document.querySelectorAll("#scheduleTableBody tr");
        const schedules = [];
        let hasEmpty = false;

        rows.forEach((r) => {
          const inputs = r.querySelectorAll("input, select");
          const emailVal = inputs[0].value; // Dropdown Dosen

          if (!emailVal) hasEmpty = true;

          schedules.push({
            email: emailVal,
            day: inputs[1].value,
            start: inputs[2].value,
            end: inputs[3].value,
            description: inputs[4].value,
          });
        });

        if (hasEmpty) {
          alert("Ada baris (ditandai Merah) di mana Dosen tidak ditemukan/tidak terpilih.\nMohon pilih dosen secara manual atau perbaiki CSV.");
          return;
        }

        if (schedules.length === 0) return;

        const btn = document.querySelector('button[onclick="saveSchedules()"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Menyimpan...";

        try {
          const res = await fetch("/api/coordinator/schedules/import", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ schedules }),
          });
          const result = await res.json();

          if (result.success) {
            alert(result.message);
            window.location.href = "/coordinator/schedules";
          } else {
            alert("Gagal: " + result.message);
          }
        } catch (e) {
          alert("Error koneksi server.");
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }
      function logout() {
        localStorage.clear();
        window.location.href = "/login";
      }
    </script>
  </body>
</html>
